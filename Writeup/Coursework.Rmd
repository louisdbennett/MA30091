---
output: 
  pdf_document:
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
header-includes:
  - \usepackage{hyperref}
  - \usepackage{array}   
  - \usepackage{caption}
  - \usepackage{graphicx}
  - \usepackage{multirow}
  - \usepackage{hhline}
  - \usepackage{calc}
  - \usepackage{tabularx}
  - \usepackage[para,online,flushleft]{threeparttable} 
  - \DeclareMathOperator{\logit}{logit}
  - \DeclareMathOperator{\var}{var}
geometry: margin=0.5in
pagenumbers: no
fontsize: 11pt
endnote: no
title: "Analysis of Health Survey for England (HSE) 2019"
author: Candidate Numbers Here
abstract: "This report provides an analysis of data related to health, age, socio-economic factors and lifestyle habits in adults (from the age of 16) from the population in England, derived from the Health Survey for England 2019."
date: "`r format(Sys.time(), '%B %d, %Y')`"
bibliography: bibliography.bib
nocite: '@*'
link-citations: true
---

<!-- Remove page numbers -->
\pagenumbering{gobble}

```{r setup, include=F}
knitr::opts_chunk$set(include = F, echo = F, message = F, warning = F)
```

<!-- Put all code at start and only call plots when we need them in line -->

```{r initial data filtering and splitting}
library(dplyr)
library(haven)
library(ggplot2)
library(broom)
library(pROC)
library(caret)
library(patchwork)

load("~/MA30091/Coursework/MA30091/Datasets/hsesub.Rdata")

fct_variables <- c(
  'Sex', 'Age35g', 'ag16g10', 'topqual2', 'urban14b', 'origin2', 'marstatD', 'GOR1', 'cigsta3_19', 'NDPNow_19', 'drinkYN_19', 'dnoft_19'
)

# filter to over 16s, relabel all factors
sd16plus <- subdat %>% 
  filter(Age35g >= 7 & !is.na(Age35g)) %>%
  mutate(
    across(
      all_of(fct_variables), 
      ~ factor(as.factor(.x), levels = attr(subdat[[cur_column()]], 'labels'), labels = names(attr(subdat[[cur_column()]], 'labels')))
    ), 
    across(!all_of(fct_variables), as.numeric)
  ) %>% 
  mutate(
    # Grouping variables
    marstatD = as.factor(
      case_when(
        grepl('Married', marstatD) ~ 'Married', 
        !is.na(marstatD) ~ 'Not Married',
        T ~ NA_character_
      )
    ),
    topqual2 = as.factor(
      case_when(
        grepl('Degree or equiv|degree|FT Student', topqual2) ~ 'Higher Education', 
        grepl('A Level equiv', topqual2) ~ 'A-Levels',
        grepl('O Level equiv|CSE other grade equiv', topqual2) ~ 'O-Levels',
        T ~ as.character(topqual2)
      )
    ),
    dnoft_19 = as.factor(
      case_when(
        dnoft_19 %in% c('Almost every day', 'Five or six days a week', 'Three or four days a week') ~ "Frequent",
        dnoft_19 %in% c('Once or twice a week', 'Once or twice a month') ~ "Occasional",
        dnoft_19 %in% c('Once every couple of months', 'Once or twice a year', 'Not at all in the last 12 months') ~ "Rarely",
        T ~ NA_character_
      )
    ),
    urban14b = as.factor(
      case_when(
        grepl('Town', urban14b) ~ 'Not Urban', 
        T ~ as.character(urban14b)
      )
    ),
    NDPNow_19 = as.factor(
      case_when(
        grepl('Both|E-cigarettes', NDPNow_19) ~ 'Smokes E-cigarettes',
        grepl('None|Other', NDPNow_19) ~ 'Doesn\'t smoke E-cigarettes',
        T ~ NA_character_
      )
    ),
    
    # Define new variables
    
    current_smoker = as.numeric(cigsta3_19 == "Current cigarette smoker"),
    age_estim = if_else(
      Age35g != "90+",
      purrr::map2_dbl(as.numeric(gsub("-.*", "", Age35g)), as.numeric(gsub(".*-", "", Age35g)), \(x, y) mean(c(x, y))),
      92.5
    )
  )
```

```{r proportion bar plot function}
create_proportion_bar_plot <- function(group_variable, facet_variable, plotting_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(
      !if_any(all_of(plotting_variable), is.na)
    ) %>% 
    group_by(
      across(all_of(c(group_variable, facet_variable, plotting_variable)))
    ) %>% 
    summarise(n = n(), .groups = 'drop_last') %>% 
    mutate(proportion = n / sum(n))
  
  ggplot(data, aes(x = !!sym(group_variable), y = proportion, fill = !!sym(plotting_variable))) +
    geom_bar(stat = "identity", position = "dodge") +
    facet_wrap(as.formula(paste("~", facet_variable)), scales = "free_x") +
    scale_fill_brewer(palette = "Pastel1", name = labels$legend.title) +
    labs(x = labels$x, y = labels$y) +
    scale_y_continuous(labels = scales::percent) +
    guides(
      fill = guide_legend(title.position = 'top', title.hjust = 0.5, title.theme = element_text(face = 'bold'))
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = 'bottom',
      strip.text = element_text(face = 'bold', size = 12),
      legend.text = element_text(size = 6), 
      legend.key.size = unit(0.4, 'cm')
    )
}
```

```{r stacked bar plot function}
create_stacked_bar_plot <- function(group_variable, plotting_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(
      !if_any(all_of(plotting_variable), is.na)
    ) %>% 
    group_by(
      across(all_of(c(group_variable, plotting_variable)))
    ) %>% 
    summarise(n = n(), .groups = 'drop_last') %>% 
    mutate(proportion = n / sum(n))
  
  ggplot(data, aes(x = !!sym(group_variable), y = proportion, fill = !!sym(plotting_variable))) +
    geom_bar(stat = "identity", position = "stack") +
    scale_fill_brewer(palette = "Pastel3", name = labels$legend.title) +
    scale_y_continuous(labels = scales::percent) +
    guides(
      fill = guide_legend(title.position = 'top', title.hjust = 0.5, title.theme = element_text(face = 'bold'))
    ) +
    labs(x = labels$x, y = labels$y) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      legend.position = 'bottom', 
      legend.text = element_text(size = 6), 
      legend.key.size = unit(0.4, 'cm')
    )
}
```

```{r confidence interval calculation}
# function to calculate the confidence intervals
calculate_binomial_ci <- function(dat_vec, weights = rep(1, length.out = length(dat_vec)), alpha = 0.05) {
  dat_vec <- as.numeric(dat_vec)
  
  n <- length(dat_vec)
  
  p_hat <- sum(dat_vec * weights) / sum(weights)
  
  var_est <- p_hat * (1 - p_hat) / sum(weights)
  
  ci <- p_hat + c(-1, 1) * qnorm(1 - alpha / 2) * sqrt(var_est)
  
  list(n = n, p_hat = p_hat, alpha = alpha, ci = ci)
}

# Initial calculations of prevelance across the three categories
# here we use full dataset, not split into test and train
drinking_na <- is.na(sd16plus$drinkYN_19)
overall_drinking <- calculate_binomial_ci(sd16plus$drinkYN_19[!drinking_na] == 'Yes', sd16plus$wt_int[!drinking_na])

smoking_na <- is.na(sd16plus$cigsta3_19)
overall_smoking <- calculate_binomial_ci(sd16plus$cigsta3_19[!smoking_na] == 'Current cigarette smoker', sd16plus$wt_int[!smoking_na])

ecig_na <- is.na(sd16plus$NDPNow_19)
overall_ecigs <- calculate_binomial_ci(sd16plus$NDPNow_19[!ecig_na] == 'Smokes E-cigarettes', sd16plus$wt_int[!ecig_na])

# Creating table output
prevelance_table <- tibble(
  Category = c('Drinking', 'Smoking', 'Smoking E-cigarettes'),
  Estimate = c(overall_drinking$p_hat, overall_smoking$p_hat, overall_ecigs$p_hat),
  LowerCI = c(overall_drinking$ci[1], overall_smoking$ci[1], overall_ecigs$ci[1]),
  UpperCI = c(overall_drinking$ci[2], overall_smoking$ci[2], overall_ecigs$ci[2])
) %>% 
  mutate(
    CI = glue::glue('({100 * signif(LowerCI, digits = 3)}%, {100 * signif(UpperCI, digits = 3)}%)'),
    Estimate = paste0(100 * signif(Estimate, digits = 3), '%')
  ) %>% 
  select(-c(LowerCI, UpperCI))
```

```{r calculations by age groups}
create_confidence_int_plot <- function(group_variable, facet_variable, plotting_variable, required_levels, labels = list()) {
  data <- sd16plus %>% 
    filter(!if_any(all_of(plotting_variable), is.na)) %>% 
    group_by(
      across(all_of(c(group_variable, facet_variable)))
    ) %>% 
    summarise(
      across(all_of(plotting_variable), ~ list(.x %in% required_levels), .names = 'dat_vec'),
      wt_int = list(wt_int), .groups = 'drop'
    ) %>% 
    mutate(
      summary = purrr::map2(dat_vec, wt_int, calculate_binomial_ci),
      p_hat = purrr::map_dbl(summary, \(x) x$p_hat),
      lower = purrr::map_dbl(summary, \(x) x$ci[1]),
      upper = purrr::map_dbl(summary, \(x) x$ci[2])
    ) %>% 
    select(-c(dat_vec, wt_int, summary))
  
  ggplot(data = data, aes(x = !!sym(group_variable), y = p_hat, ymin = lower, ymax = upper)) +
    geom_point(size = 3) +
    geom_errorbar(width = 0.5) +
    facet_wrap(as.formula(paste('~ ', facet_variable))) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = labels$x, y = labels$y) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      strip.text = element_text(face = 'bold', size = 12)
    )
}
```

```{r splitting dataset into test and train}
# split data into test/train
train16plus <- sd16plus %>% sample_frac(0.8) 
test16plus <- sd16plus %>% anti_join(train16plus, by = c('SerialA'))
```

```{r summary of data set}
variable_na_table <- train16plus %>% 
  select(-c(SerialA, current_smoker, age_estim)) %>% 
  summarise(
    across(everything(), ~ sum(is.na(.x)))
  ) %>% 
  tidyr::pivot_longer(
    cols = everything(), names_to = 'Variable', values_to = 'SumNA'
  ) %>% 
  # Can filter out variables with 0 NAs for table?
  filter(SumNA != 0) %>%
  mutate(PercNA = paste0(100 * signif(SumNA / NROW(train16plus), digits = 3), '%')) %>% 
  arrange(desc(SumNA))
```

```{r fitting q2 model}
get_binom_model_diagnostics <- function(formula) {
  fit <- glm(formula, data = train16plus, family = binomial)
  
  aic <- AIC(fit)
  
  # predicting train values
  pred_train <- predict(fit, newdata = train16plus, type = 'response')
  
  train_rmse <- sqrt(mean((train16plus$current_smoker - pred_train) ^ 2, na.rm = T))
  
  # predicting test values
  pred_test <- predict(fit, newdata = test16plus, type = 'response')
  
  auc <- as.numeric(auc(response = test16plus$current_smoker, predictor = pred_test))
  
  test_rmse <- sqrt(mean((test16plus$current_smoker - pred_test) ^ 2, na.rm = T))
  
  accuracy <- mean(round(pred_test) == test16plus$current_smoker, na.rm = T)
  
  tibble(
    model = list(fit), link = 'logit', family = 'binomial', aic = aic, auc = auc, train_rmse = train_rmse, test_rmse = test_rmse, accuracy = accuracy
  )
}

# Define the model formulas
binom_model_formulas <- list(
  glm1 = current_smoker ~ age_estim + I(age_estim ^ 2) + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex + qimd19:urban14b,
  glm2 = current_smoker ~ age_estim + I(age_estim ^ 2) + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm3 = current_smoker ~ age_estim + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm4 = current_smoker ~ Age35g + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm5 = current_smoker ~ ag16g10 + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex
)

# loop over formulas
model_diagnostics <- lapply(binom_model_formulas, get_binom_model_diagnostics) %>% bind_rows()

# selected model
q2_model <- model_diagnostics$model[[which.min(model_diagnostics$aic)]]
```

```{r create q2 model selector table}
model_specs <- c(
  "$\\logit(\\mu_i) \\sim a_i + a_i^2 + m_i + q_i + u_i + o_i + t_i + s_i + q_i:u_i$",
  "$\\logit(\\mu_i) \\sim a_i + a_i^2 + m_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\logit(\\mu_i) \\sim a_i + m_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\logit(\\mu_i) \\sim a_i^{(5)} + m_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\logit(\\mu_i) \\sim a_i^{(10)} + m_i + q_i + u_i + o_i + t_i + s_i$"
)

model_table_output <- model_diagnostics %>% 
  select(aic, auc, train_rmse, test_rmse, accuracy) %>% 
  mutate(
    formula = model_specs, 
    aic = round(aic, digits = 1),
    across(c(auc:accuracy), ~ round(.x, digits = 3)),
    .before = 1
  )
```

```{r calibration chart function}
create_binom_model_calibration_chart <- function(fit) {
  pred <- predict(fit, test16plus, type = 'response')
  
  actual <- test16plus$current_smoker
  
  ggplot(mapping = aes(x = pred, y = actual)) +
    stat_summary_bin(fun = "mean", bins = 10, geom = "point") +  # Bin and plot mean actual per bin
    stat_summary_bin(fun = "mean", bins = 10, geom = "line", aes(group = 1)) +  # Connect points with lines
    labs(x = "Predicted Probability", y = "Mean Actual Outcome") +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
    theme_minimal()
}
```

<!-- Start of write-up -->

\newpage
## Summary (Non-Technical)

## Introduction

In the UK, smoking, vaping, and alcohol consumption are widespread, particularly among youngsters. It is crucial to be aware of the consequences and dangers of these habits, and the complications they can cause in later-life.
The Office for National Statistics (ONS), regarded as the foremost statistical institute in the UK, is the “go-to” for insights into public health trends. According to their estimations, approximately 14.1% of the adult population aged 18 and above were identified as cigarette smokers [@1ONS]. Furthermore, their data revealed there were 7,565 deaths attributed to alcohol-specific causes in 2019 [@2ONS].
These statistics alone warrant a need for an understanding of health-related behaviours and the outcome. Therefore, the aim of our study is to investigate not only the prevalence but also the severity of these habits, exploring different socioeconomic factors that may potentially contribute to each. Additionally, we will investigate the greater implications of these bad habits and how they relate to systolic blood pressure levels throughout the UK population.

## Exploratory Analysis

**We start by investigating the data**

```{r output smoking and drinking by age plot, include = T, fig.width=12, fig.height=4, fig.cap="Smoking and drinking status proportions by age group and gender"}
p1 <- create_proportion_bar_plot('ag16g10', 'Sex', 'cigsta3_19', labels = list(x = 'Age Group', y = 'Proportion', legend.title = 'Smoking Status'))
p2 <- create_proportion_bar_plot('ag16g10', 'Sex', 'dnoft_19', labels = list(x = 'Age Group', y = 'Proportion', legend.title = 'Drinking Status'))

p1 + p2
```
<!-- these slashes are needed to insert breaks after plots -->
\

```{r output deprivation plot, include = T, fig.width=10, fig.height=3, fig.cap="Drinking, smoking and E-cig status proportions by level of deprivation"}
p1 <- create_stacked_bar_plot('qimd19', 'cigsta3_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'Drinking Status'))
p2 <- create_stacked_bar_plot('qimd19', 'dnoft_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'Smoking Status'))
p3 <- create_stacked_bar_plot('qimd19', 'NDPNow_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'E-cig Status'))

p1 + p2 + p3
```
\

## Methology

**Define all variables used in analysis**

## Analysis

### What is the prevelance of drinking, smoking and E-cig usage?

To calculate the prevalence of each habit we assume each of the $n$ observations, $x_1,…,x_n$ , to be independent, identically distributed (iid) random variables (RVs) where $x_i \sim Bern(p)\, \forall i=1,…,n$ and $p$ denotes the probability of an observation having the relevant habit. 
We use the household weights to calculate a weighted Maximum Likelihood Estimate (MLE) of $p$. That is, letting $w_i$ denote the weight of the $i^{th}$ observation, we alter the standard likelihood function of a Bernoulli distribution as below:
$$L(p|\textbf{x}) = \prod_{i = 1}^{n} (p^{x_i}(1-p)^{1-x_i})^{w_i}$$
From this, we calculate our weighted MLE as:
$$\widehat{p} = \frac{\sum_{i=1}^{n} x_iw_i}{\sum_{i=1}^{n} w_i}$$

It can also be shown that this MLE has variance given by $\var(\widehat{p})=\frac{p(1-p)}{\sum_{i=1}^{n}w_i}$, which we can estimate using $\widehat{p}$ and use large sample properties of the MLE to get a normal approximation and estimate 95% confidence intervals for each habit, which are shown in the table below.

```{r output estimates table, include = T}
knitr::kable(
  prevelance_table, 
  col.names = c('Habit', 'Estimate', 'C.I.'), 
  caption = "Estimates and 95% Confidence Intervals for % of Population"
)
```

**Interpretation of table/results - e-cig is much lower, drinking very common etc**

**We can also...**

```{r output prevelance plot, include = T, fig.width=12, fig.height=4, fig.cap="Estimation of the prevelance of smokers by deprivation"}
create_confidence_int_plot('qimd19', 'Sex', 'cigsta3_19', required_levels = c('Current cigarette smoker'), list(x = 'Deprivation', y = '% Smokers'))
```
\

<!-- Are we doing the same for Gamma distribution with number of cigarettes here? -->

### How is smoking associated with socioeconomic factors and age?

**Explanation of why we split into test/train dataset.**

This leaves us with `r NROW(train16plus)` observations in our training dataset. The number of missing observations for each are shown:

```{r output NA table, include = T}
knitr::kable(
  variable_na_table, 
  col.names = c('Variable', 'Missing Values', '% Missing'), 
  caption = "Missing values in the training dataset"
)
```

**Explanation of first model - binomial with logit link**

```{r output model selection table, include = T}
knitr::kable(
  model_table_output,
  col.names = c('Linear Predictor', 'Train AIC', 'Test AUC', "Train RMSE", "Test RMSE", 'Test Accuracy'), 
  caption = "Comparison of selected model evaluations",
  escape = FALSE
)
```

**Explain why we selected the model we did - lowest AIC**

**Some model diagnostics**

```{r output calibration chart, include = T, fig.width=10, fig.height=4, fig.cap="Calibration chart for binomial model"}
create_binom_model_calibration_chart(q2_model)
```


**Interpretation of model coefficients etc**

**Limitations of model**

### Which lifestyle habits are associated with systolic blood pressure?

**Question Three**

## Results/Conclusion

\newpage
# References