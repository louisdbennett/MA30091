---
output: 
  pdf_document:
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    extra_dependencies: ["float"]
header-includes:
  - \usepackage{hyperref}
  - \usepackage{array}   
  - \usepackage{caption}
  - \usepackage{graphicx}
  - \usepackage{multirow}
  - \usepackage{hhline}
  - \usepackage{calc}
  - \usepackage{tabularx}
  - \usepackage[para,online,flushleft]{threeparttable} 
  - \DeclareMathOperator{\logit}{logit}
  - \DeclareMathOperator{\var}{var}
geometry: margin=0.5in
pagenumbers: no
fontsize: 11pt
endnote: no
title: "Analysis of Health Survey for England (HSE) 2019"
author: Candidate Numbers Here
abstract: "This report provides an analysis of data related to health, age, socio-economic factors and lifestyle habits in adults (from the age of 16) from the population in England, derived from the Health Survey for England 2019."
date: "`r format(Sys.time(), '%B %d, %Y')`"
bibliography: bibliography.bib
nocite: '@*'
link-citations: true
classoption:
- twocolumn
---

<!-- Remove page numbers -->
\pagenumbering{gobble}

```{r setup, include=F}
knitr::opts_chunk$set(include = F, echo = F, message = F, warning = F, fig.pos = "H", out.extra = "")
```

<!-- Put all code at start and only call plots when we need them in line -->

```{r initial data filtering and splitting}
library(dplyr)
library(haven)
library(ggplot2)
library(broom)
library(pROC)
library(caret)
library(kableExtra)

set.seed(200)

load("hsesub.Rdata")

fct_variables <- c(
  'Sex', 'Age35g', 'ag16g10', 'topqual2', 'urban14b', 'origin2', 'marstatD', 'GOR1', 'cigsta3_19', 'NDPNow_19', 'drinkYN_19', 'dnoft_19'
)

# filter to over 16s, relabel all factors
sd16plus <- subdat %>% 
  filter(Age35g >= 7 & !is.na(Age35g)) %>% 
  # Remove duplicated entries
  distinct(pick(!c(SerialA)), .keep_all = T) %>% 
  mutate(
    across(
      all_of(fct_variables), 
      # drop excess factor levels
      ~ droplevels(factor(as.factor(.x), levels = attr(subdat[[cur_column()]], 'labels'), labels = names(attr(subdat[[cur_column()]], 'labels'))))
    ), 
    across(!all_of(fct_variables), as.numeric)
  ) %>% 
  mutate(
    # Grouping variables
    marstatD = as.factor(
      case_when(
        grepl('Married', marstatD) ~ 'Married', 
        !is.na(marstatD) ~ 'Not Married',
        T ~ NA_character_
      )
    ),
    topqual2 = as.factor(
      case_when(
        grepl('Higher ed|FT Student', topqual2) ~ 'Higher Education', 
        grepl('NVQ4', topqual2) ~ 'Further Education',
        grepl('NVQ3', topqual2) ~ 'A-Level equiv.',
        grepl('NVQ1|NVQ2', topqual2) ~ 'GCSE equiv.',
        T ~ as.character(topqual2)
      )
    ),
    dnoft_19 = as.factor(
      case_when(
        dnoft_19 %in% c('Almost every day', 'Five or six days a week', 'Three or four days a week') ~ "Frequent",
        dnoft_19 %in% c('Once or twice a week', 'Once or twice a month') ~ "Occasional",
        dnoft_19 %in% c('Once every couple of months', 'Once or twice a year', 'Not at all in the last 12 months') ~ "Rarely",
        T ~ NA_character_
      )
    ),
    urban14b = as.factor(
      case_when(
        grepl('Town', urban14b) ~ 'Rural', 
        T ~ as.character(urban14b)
      )
    ),
    origin2 = as.factor(
      case_when(
        grepl('Mixed', origin2) ~ 'Multiple',
        grepl('other', origin2) ~ 'Other',
        T ~ as.character(origin2)
      )
    ),
    NDPNow_19 = as.factor(
      case_when(
        grepl('Both|E-cigarettes', NDPNow_19) ~ 'Smokes E-cigarettes',
        grepl('None|Other', NDPNow_19) ~ 'Doesn\'t smoke E-cigarettes',
        T ~ NA_character_
      )
    ),
    
    # Define new variables
    
    current_smoker = as.numeric(cigsta3_19 == "Current cigarette smoker"),
    age_estim =
      case_when(
        Age35g != "90+" ~ purrr::map2_dbl(as.numeric(substr(Age35g,0,2)), as.numeric(substr(Age35g,4,5)), \(x, y) mean(c(x, y))),
        !(is.na(Age35g)) ~ 92.5,
        T ~ NA_real_
      )
  )
```

```{r proportion bar plot function}
create_proportion_bar_plot <- function(group_variable, facet_variable, plotting_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(
      !if_any(all_of(plotting_variable), is.na)
    ) %>% 
    group_by(
      across(all_of(c(group_variable, facet_variable, plotting_variable)))
    ) %>% 
    summarise(n = n(), .groups = 'drop_last') %>% 
    mutate(proportion = n / sum(n))
  
  ggplot(data, aes(x = !!sym(group_variable), y = proportion, fill = !!sym(plotting_variable))) +
    geom_bar(stat = "identity", position = "dodge") +
    facet_wrap(as.formula(paste("~", facet_variable)), scales = "free_x") +
    scale_fill_brewer(palette = "Pastel1", name = labels$legend.title) +
    labs(x = labels$x, y = labels$y) +
    scale_y_continuous(labels = scales::percent) +
    guides(
      fill = guide_legend(title.position = 'top', title.hjust = 0.5, title.theme = element_text(face = 'bold'))
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = 'bottom',
      strip.text = element_text(face = 'bold', size = 12),
      legend.text = element_text(size = 6), 
      legend.key.size = unit(0.4, 'cm')
    )
}
```

```{r stacked bar plot function}
create_stacked_bar_plot <- function(group_variable, plotting_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(
      !if_any(all_of(plotting_variable), is.na)
    ) %>% 
    group_by(
      across(all_of(c(group_variable, plotting_variable)))
    ) %>% 
    summarise(n = n(), .groups = 'drop_last') %>% 
    mutate(proportion = n / sum(n))
  
  ggplot(data, aes(x = !!sym(group_variable), y = proportion, fill = !!sym(plotting_variable))) +
    geom_bar(stat = "identity", position = "stack") +
    scale_fill_brewer(palette = "Pastel3", name = labels$legend.title) +
    scale_y_continuous(labels = scales::percent) +
    guides(
      fill = guide_legend(title.position = 'top', title.hjust = 0.5, title.theme = element_text(face = 'bold'))
    ) +
    labs(x = labels$x, y = labels$y) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      legend.position = 'bottom', 
      legend.text = element_text(size = 6), 
      legend.key.size = unit(0.4, 'cm')
    )
}
```

```{r confidence interval calculation}
# function to calculate the confidence intervals
calculate_binomial_ci <- function(dat_vec, weights = rep(1, length.out = length(dat_vec)), alpha = 0.05) {
  dat_vec <- as.numeric(dat_vec)
  
  n <- length(dat_vec)
  
  p_hat <- sum(dat_vec * weights) / sum(weights)
  
  var_est <- p_hat * (1 - p_hat) / sum(weights)
  
  ci <- p_hat + c(-1, 1) * qnorm(1 - alpha / 2) * sqrt(var_est)
  
  list(n = n, p_hat = p_hat, alpha = alpha, ci = ci)
}

# Initial calculations of prevelance across the three categories
# here we use full dataset, not split into test and train
drinking_na <- is.na(sd16plus$drinkYN_19)
overall_drinking <- calculate_binomial_ci(sd16plus$drinkYN_19[!drinking_na] == 'Yes', sd16plus$wt_int[!drinking_na])

smoking_na <- is.na(sd16plus$cigsta3_19)
overall_smoking <- calculate_binomial_ci(sd16plus$cigsta3_19[!smoking_na] == 'Current cigarette smoker', sd16plus$wt_int[!smoking_na])

ecig_na <- is.na(sd16plus$NDPNow_19)
overall_ecigs <- calculate_binomial_ci(sd16plus$NDPNow_19[!ecig_na] == 'Smokes E-cigarettes', sd16plus$wt_int[!ecig_na])

# Creating table output
prevelance_table <- tibble(
  Category = c('Drinking', 'Smoking', 'Smoking E-cigarettes'),
  Estimate = c(overall_drinking$p_hat, overall_smoking$p_hat, overall_ecigs$p_hat),
  LowerCI = c(overall_drinking$ci[1], overall_smoking$ci[1], overall_ecigs$ci[1]),
  UpperCI = c(overall_drinking$ci[2], overall_smoking$ci[2], overall_ecigs$ci[2])
) %>% 
  mutate(
    CI = glue::glue('({100 * signif(LowerCI, digits = 3)}%, {100 * signif(UpperCI, digits = 3)}%)'),
    Estimate = paste0(100 * signif(Estimate, digits = 3), '%')
  ) %>% 
  select(-c(LowerCI, UpperCI))
```

```{r confidence interval plots}
create_confidence_int_plot <- function(group_variable, facet_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(!if_any(c(cigsta3_19, drinkYN_19, NDPNow_19), is.na)) %>% 
    group_by(
      across(all_of(c(group_variable, facet_variable)))
    ) %>% 
    summarise(
      cig = list(cigsta3_19 == 'Current cigarette smoker'),
      alc = list(drinkYN_19 == 'Yes'),
      ecig = list(NDPNow_19 == 'Smokes E-cigarettes'),
      wt_int = list(wt_int), 
      .groups = 'drop'
    ) %>% 
    mutate(
      across(c(cig, alc, ecig), ~ purrr::map2(.x, wt_int, calculate_binomial_ci))
    ) %>% 
    select(-c(wt_int)) %>%
    tidyr::pivot_longer(
      cols = c(cig:ecig), names_to = 'category', values_to = 'summary'
    ) %>% 
    mutate(
      p_hat = purrr::map_dbl(summary, \(x) x$p_hat),
      lower = purrr::map_dbl(summary, \(x) x$ci[1]),
      upper = purrr::map_dbl(summary, \(x) x$ci[2])
    ) %>% 
    select(-c(summary))
  
  ggplot(data = data, aes(x = !!sym(group_variable), y = p_hat, ymin = lower, ymax = upper, group = category, fill = category)) +
    geom_bar(stat = 'identity', position = position_dodge(width = 1)) +
    geom_errorbar(width = 0.5, position = position_dodge(width = 1)) +
    facet_wrap(as.formula(paste('~ ', facet_variable))) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = labels$x, y = labels$y) +
    scale_fill_brewer(
      palette = "Pastel1", name = labels$legend.title, labels = c("ecig" = "Smoking E-Cigarettes", "cig" = "Smoking", 'alc' = 'Drinking')
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = 'bold', size = 12), legend.position = 'bottom'
    )
}
```

```{r splitting dataset into test and train}
# split data into test/train
train16plus <- sd16plus %>% sample_frac(0.8) 
test16plus <- sd16plus %>% anti_join(train16plus, by = c('SerialA'))
```

```{r summary of data set}
variable_na_table <- sd16plus %>% 
  select(-c(SerialA, current_smoker, age_estim)) %>% 
  summarise(
    across(everything(), ~ sum(is.na(.x)))
  ) %>% 
  tidyr::pivot_longer(
    cols = everything(), names_to = 'Variable', values_to = 'SumNA'
  ) %>% 
  # Can filter out variables with 0 NAs for table?
  filter(SumNA != 0) %>%
  mutate(PercNA = paste0(100 * signif(SumNA / NROW(train16plus), digits = 3), '%')) %>% 
  arrange(desc(SumNA))

variable_na_table_train <- train16plus %>% 
  select(-c(SerialA, current_smoker, age_estim)) %>% 
  summarise(
    across(everything(), ~ sum(is.na(.x)))
  ) %>% 
  tidyr::pivot_longer(
    cols = everything(), names_to = 'Variable', values_to = 'SumNA'
  ) %>% 
  # Can filter out variables with 0 NAs for table?
  filter(SumNA != 0) %>%
  mutate(PercNA = paste0(100 * signif(SumNA / NROW(train16plus), digits = 3), '%')) %>% 
  arrange(desc(SumNA))
```

```{r fitting q2 model}
get_binom_model_diagnostics <- function(formula) {
  fit <- glm(formula, data = train16plus, family = binomial)
  
  aic <- AIC(fit)
  
  # predicting train values
  pred_train <- predict(fit, newdata = train16plus, type = 'response')
  
  train_rmse <- sqrt(mean((train16plus$current_smoker - pred_train) ^ 2, na.rm = T))
  
  # predicting test values
  pred_test <- predict(fit, newdata = test16plus, type = 'response')
  
  auc <- as.numeric(auc(response = test16plus$current_smoker, predictor = pred_test))
  
  test_rmse <- sqrt(mean((test16plus$current_smoker - pred_test) ^ 2, na.rm = T))
  
  accuracy <- mean(round(pred_test) == test16plus$current_smoker, na.rm = T)
  
  tibble(
    model = list(fit), link = 'logit', family = 'binomial', aic = aic, auc = auc, train_rmse = train_rmse, test_rmse = test_rmse, accuracy = accuracy
  )
}

# Define the model formulas
binom_model_formulas <- list(
  glm1 = current_smoker ~ age_estim + I(age_estim ^ 2) + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex + qimd19:urban14b,
  glm2 = current_smoker ~ age_estim + I(age_estim ^ 2) + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm3 = current_smoker ~ age_estim + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm4 = current_smoker ~ Age35g + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm5 = current_smoker ~ ag16g10 + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex
)

# loop over formulas
model_diagnostics <- lapply(binom_model_formulas, get_binom_model_diagnostics) %>% bind_rows()

# selected model
q2_model <- model_diagnostics$model[[which.min(model_diagnostics$aic)]]
```

```{r create q2 model selector table}
model_specs <- c(
  "$\\eta_i \\sim a_i + a_i^2 + ms_i + q_i + u_i + o_i + t_i + s_i + q_i:u_i$",
  "$\\eta_i \\sim a_i + a_i^2 + ms_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\eta_i \\sim a_i + ms_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\eta_i \\sim a_i^{(5)} + ms_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\eta_i \\sim a_i^{(10)} + ms_i + q_i + u_i + o_i + t_i + s_i$"
)

model_table_output <- model_diagnostics %>% 
  select(aic, auc, train_rmse, test_rmse, accuracy) %>% 
  mutate(
    formula = model_specs, 
    aic = round(aic, digits = 1),
    across(c(auc:accuracy), ~ round(.x, digits = 3)),
    .before = 1
  )
```

```{r calibration chart function}
create_binom_model_calibration_chart <- function(fit) {
  pred <- predict(fit, test16plus, type = 'response')
  
  actual <- test16plus$current_smoker
  
  ggplot(mapping = aes(x = pred, y = actual)) +
    stat_summary_bin(fun = "mean", bins = 10, geom = "point") +  # Bin and plot mean actual per bin
    stat_summary_bin(fun = "mean", bins = 10, geom = "line", aes(group = 1)) +  # Connect points with lines
    labs(x = "Predicted Probability", y = "Mean Actual Outcome") +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
    xlim(c(0, 1)) +
    ylim(c(0, 1)) +
    theme_minimal()
}
```

```{r distribution plots}
create_distribution_plot <- function(variable, label) {
  ggplot() +
  geom_violin(
    data = sd16plus, aes(y = !!sym(variable), x = as.factor(1)),
    scale = "width", alpha = 0.5, color = "black", fill = "blue"
  ) +
  geom_boxplot(
    data = sd16plus, aes(y = !!sym(variable), x = as.factor(1)),
    width = 0.2,
    fill = "white", 
    outlier.shape = 3, 
    outlier.colour = "red", 
    outlier.alpha = 1, 
    outlier.size = 4
  ) +
  ylab(label) +
  theme_minimal() +
  coord_flip() +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
}
```

```{r fitting q3 model}
q3_model <- glm(
  formula = omsysval ~ cigsta3_19 + age_estim + marstatD + urban14b + BMIVal + I(BMIVal ^ 2) + Sex + d7many3_19 + BMIVal:Sex + age_estim:Sex + BMIVal:age_estim,
  family = inverse.gaussian,
  # Filter out BMI outliers and NA omsysval
  data = train16plus %>% filter(BMIVal <= 54, !is.na(omsysval), !is.na(BMIVal))
)
```

```{r qqplot function}
create_qq_plot <- function(fit) {
  pred <- rstandard(fit)
  
  ggplot(mapping = aes(sample = pred)) +
    stat_qq() +
    stat_qq_line(linetype = 'dashed', col = 'red') +
    theme_minimal() +
    labs(x = "Theoretical Quantiles", y = "Std. Pearson Residuals")
}
```

```{r relationship plots for q3}
create_relationship_plots <- function(variable, labels) {
  ggplot(data = train16plus, aes(x = !!sym(variable), y = omsysval)) +
    geom_point() +
    geom_smooth() +
    labs(y = "Omron Valid Mean Systolic Blood Pressure (mmHg)", x = labels$x) +
    theme_minimal()
}
```

```{r some model plots for q3}
pred <- predict(q3_model, test16plus, type = 'response')
q3_rmse <- sqrt(mean((test16plus$omsysval - pred) ^ 2, na.rm = T))

create_effects_plot <- function(fit, terms, labels = list()) {
  sjPlot::plot_model(fit, type = "pred", terms = terms) +
    labs(x = labels$x, y = labels$y) +
    theme_minimal() +
    theme(plot.title = element_blank(), legend.position = 'bottom', legend.title = element_blank())
}

mean_drinking_change <- tibble(ggeffects::ggpredict(model = q3_model, terms = c('d7many3_19'))) %>% pull(predicted) %>% diff() %>% mean()
cig_sex_effects <- tibble(ggeffects::ggpredict(model = q3_model, terms = c('cigsta3_19', 'Sex'))) %>% 
  mutate(x = gsub(" .*", "", x)) %>% 
  filter(x != "Ex-regular") %>% 
  select(x, predicted, group) %>% 
  tidyr::pivot_wider(id_cols = group, names_from = x, values_from = predicted) %>%
  mutate(
    percentage_change = 100 * (Current - Never) / Never
  )
age_sex_effects <- tibble(ggeffects::ggpredict(model = q3_model, terms = c('age_estim', 'Sex')))
```


<!-- Start of write-up -->

\clearpage
## Summary (Non-Technical)

## Introduction

In the UK, smoking, “vaping” and alcohol consumption are widespread habits among adults, particularly younger adults. In fact, it is estimated that around 14.1% of UK adults identified as cigarette smokers [@1ONS], and a similar study found that there were 7,565 deaths attributed to alcohol-specific causes in 2019 [@2ONS]. Thus, it is crucial to be aware of the predictors and consequences of these habits, which is the motivation for this analysis. We conducted this analysis on a subset containing 8,204 adults living in England (ages 16+), who were interviewed in their homes about their demographics and their smoking and drinking habits as part of the Health Survey for England (HSE) 2019. 4,947 of these participants who consented to an at-home nurse visit had vitals such as blood pressure, weight and height measured. We investigated which features of a participant are associated with smoking habits, and which habits are associated with high blood pressure.
The mechanisms which drive lifestyle habits are part of a complex and ever-changing field in behavioural psychology. What is known, however, is that such habits are driven by cues and cravings (ask Cam for the citation). The HSE 2019 captures demographic and socioeconomic characteristics that have the potential to make such cues more visible and cravings harder to resist. For example, living in a region where smoking is more prevalent, like ones with higher deprivation [citation needed], or not having a husband/wife for an accountability partner to help you quit or resist these habits.
In this report, we will use weighting variables to estimate prevalence of cigarette, e-cig, and alcohol users in our population, and compare it with the larger population of adults in England. We will then attempt to identify associations with a participants current smoking status, explore whether predictive modelling can be used to identify smokers with a high accuracy, and investigate which lifestyle habits are associated with increased values of systolic blood pressure. *This will be crucial in enabling healthcare providers to implement preventative care for people at risk of developing hypertension.*

## Exploratory Analysis

The full HSE 2019 cross-sectional data set contains 10,299 observations across thousands of variables [cite the dataset here], but we only studied patients over the age of 16 among key variables. Our subset includes 8,204 participants and 19 variables, which are grouped into five categories and described in Table ??.

**Table ??**

We found 36 pairs of observations with exactly equal variables (excluding ID variables and lab measurements), but we did not remove these from our analysis because the supporting documentation doesn’t state a protocol for repeated visits. We assumed these were genuine observations from different participants and thus included them in our dataset. However, there were 3 pairs of observations that had duplicate lab variables also. We believed that these were true duplicates and removed one observation from each of the three pairs resulting in a dataset of `r NROW(sd16plus)` observations.

All variables are coded as numeric in our dataset, so we recoded all factor variables accordingly. Some of the variables used for analysis were dichotomised by us for easier interpretation. We coded a binary variable indicating current smoking status, which will serve as our *primary* outcome variable. Also, we dichotomised urbanity into two levels being ‘Rural’ and ‘Urban’, and finally marital status was dichotomised into ‘Married’ and ‘Not Married’. We group respondents into ‘Higher Education’, ‘Further Education’, 'A-Level equiv.', 'GCSE equiv.', 'No qualification' and 'Foreign/other'.

The number of missing observations for each are shown in Table \ref{tab:output-na-table}:

```{r outputnatable, include = T}
kbl(
  variable_na_table, 
  col.names = c('Variable', 'Missing Values', '% Missing'), 
  caption = "Missing values in the training dataset\\label{tab:output-na-table}",
  longtable=F) %>% row_spec (0, bold = T)
```

There is significant missingness in the lab values, which can be explained by the fact additional consent was needed from the participant to allow a nurse visit. One variable with a substantial amount of data missing was the frequency of drinking in the last 12 months, which due to the retrospective and sensitive nature of the question could be explained by either recall bias or a participant’s refusal to answer. Education level, marital status and ethnicity are the only demographic variables with any missing entries, with `r filter(variable_na_table, Variable == 'topqual2')$SumNA` observations (`r filter(variable_na_table, Variable == 'topqual2')$PercNA` of the data) missing at least one of the three. These are not necessary for identifiability and as they are sensitive, we do not expect every participant to answer these questions. Therefore, we did not remove these observations.

We analysed the two lab measurement variables in Figure \ref{fig:output-distribution-plots}, finding potential outliers to be present in both. There were many outliers for BMI, which we note used self-estimated weight from the participant in the calculation when it exceeded 130kg. Additionally, weight measurements were taken in inconsistent environments such as on different flooring in the participants’ homes which has been shown in previous research to impact measurements accuracy [citation needed]. We believed this could have explained the extremely high BMI values such as *LIST EXAMPLES*, and so coded them as missing in the analysis dataset.

The readings for systolic blood pressure were collected by taking an average of three readings, each five minutes apart, performed by a trained nurse who had to declare each reading to be valid. For this reason, it seemed highly unlikely that these readings were mistakes, and so we included them in our analysis. We did, however, note that values of systolic blood pressure that were this consistently high (>140mmHg) were indicators for hypertensive crisis, and so a part of our population may have serious underlying health conditions that could affect the generalisability of our findings [citation needed].

```{r output-distribution-plots, include = T, fig.height=4, fig.width=10, fig.cap="Distribution of BMI and Mean Systolic Blood Pressure"}
p1 <- create_distribution_plot('omsysval', 'Omron Valid Mean Systolic Blood Pressure (mmHg)')
p2 <- create_distribution_plot('BMIVal', 'Body Mass Index (kg/m^2)') +
  geom_hline(yintercept = c(18.5, 25, 30), colour = c("orange", "orange", "red"), size = 0.5) +
  geom_text(
    aes(x = 0.4, y = c(18.4, 24.9, 29.9), label = c("Underweight", "Overweight", "Obese")), 
    color = "black", angle = 90, size = 4, vjust = 0, hjust = 0
  )

cowplot::plot_grid(p1, p2)
```

```{r output deprivation plot, include = F, fig.width=10, fig.height=4, fig.cap="Drinking, smoking and E-cig status proportions by level of deprivation"}
p1 <- create_stacked_bar_plot('qimd19', 'cigsta3_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'Drinking Status'))
p2 <- create_stacked_bar_plot('qimd19', 'dnoft_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'Smoking Status'))
p3 <- create_stacked_bar_plot('qimd19', 'NDPNow_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'E-cig Status'))

cowplot::plot_grid(p1, p2, p3)
```

## Methology

### What is the prevelance of drinking, smoking and E-cig usage?

To calculate the prevalence of each habit we assumed each of the $n$ observations, $x_1,…,x_n$ , to be independent, identically distributed (iid) random variables (RVs) where $x_i \sim Bern(p)\, \forall i=1,…,n$ and $p$ denotes the probability of an observation having the relevant habit. 
We use the household weights to calculate a weighted Maximum Likelihood Estimate (MLE) of $p$. That is, letting $w_i$ denote the weight of the $i^{th}$ observation, we altered the standard likelihood function of a Bernoulli distribution as below:
$$L(p|\textbf{x}) = \prod_{i = 1}^{n} (p^{x_i}(1-p)^{1-x_i})^{w_i}$$
From this, we calculated our weighted MLE as $\widehat{p} = \frac{\sum_{i=1}^{n} x_iw_i}{\sum_{i=1}^{n} w_i}$. It can also be shown that this MLE has variance given by $\var(\widehat{p})=\frac{p(1-p)}{\sum_{i=1}^{n}w_i}$, which we estimated using $\widehat{p}$. We used large sample properties of the MLE to get a normal approximation and estimated 95% confidence intervals for each habit, which are shown in Table \ref{tab:output-estimates-table}.

```{r outputestimatestable, include = T}
kbl(
  prevelance_table, 
  col.names = c('Habit', 'Estimate', 'C.I.'), 
  caption = "Estimates and 95\\% Confidence Intervals for \\% of Population\\label{tab:output-estimates-table}",
  longtable=F
) %>% row_spec (0, bold = T)
```

We found that the usage of e-cigarette usage among adults is relatively low, making it challenging to dissect any significant trends within the data. *Maybe a wee bit more here*

Next, we worked to uncover factors that have possible associations with smoking prevalence. We started with the demographic factors of age and gender, plotting the smoking prevalence across combinations of these groups to identify any patterns. Figure \ref{fig:output-prevelance-plot} suggests a negative correlation between age and the proportion of current cigarette smokers, across both genders. Interestingly, the proportion of males who quit smoking in later-life was much greater than that of females (75yrs+; M: 50%, F: 31%), which could be attributed to men being at a higher risk of smoking-related diseases [citation needed].

```{r output-smoking-drinking-age-plot, include = T, fig.width=12, fig.height=4, fig.cap="Smoking and drinking status proportions by age group and gender"}
p1 <- create_proportion_bar_plot('ag16g10', 'Sex', 'cigsta3_19', labels = list(x = 'Age Group', y = 'Proportion', legend.title = 'Smoking Status'))
p2 <- create_proportion_bar_plot('ag16g10', 'Sex', 'dnoft_19', labels = list(x = 'Age Group', y = 'Proportion', legend.title = 'Drinking Status'))

cowplot::plot_grid(p1, p2)
```

```{r output-prevelance-plot, include = T, fig.height=4, fig.width=12, fig.cap="Estimation of the prevelance of smokers by deprivation"}
create_confidence_int_plot('ag16g10', 'Sex', list(x = 'Age Group', y = '% Prevelance In Population', legend.title = "Habit"))
```

*Additionally, males demonstrate a higher prevalence of drinking across nearly all demographic categories in comparison to females.*
*We can clearly see that smoking prevalence increases with our deprivation variable, meaning that smokers tend to be from lower levels of deprivation. This correlation may be caused by the hefty tobacco duties the UK impose on its’ residents [@GovUK]. Less deprived individuals they can take-up more unnecessary, expensive habits, with smoking being one of the main candidates.*

### How is smoking associated with socioeconomic factors and age?

We reserved 80% of our data to train the model, and used the remaining 20% to test the model, which was made possible due to the large size of our dataset. The training set contained `r NROW(train16plus)` observations and the test set contained `r NROW(test16plus)`. *Table Z summarises the key variables between the test and train dataset to illustrate that both are representative of the whole dataset.* This reduced the risk of overfitting and allowed us to test the predictive power of each model we proposed.

To develop a predictive model for identifying smokers, we used the binary variable for current smoking status as a response, with various socioeconomic and demographic factors as predictors. These were selected based on the associations suggested by our prior analysis.

In the dataset, there were two variables that categorised age. They differed only in the size of the bands used, with one using 10-year bands and one using 5-year bands. After comparing identical models that used one or the other, we found that modelling with smaller bands improved the effectiveness of the model. 

Under the assumption that ages were approximately uniformly distributed within their respective age bands, we also defined the estimated age of the $i^{th}$ observation as the midpoint of their respective 5-year age bracket (taking the estimation of the 90+ category as 92.5), denoted $a_i$. We found that age may represent a somewhat quadratic effect on the probability of smoking, leading us to include a $a_i^2$ term in our model. A comparison of these models are summarised in Table \ref{tab:output-model-selection-table}.

```{r outputmodelselectiontable, include = T}
kbl(
  model_table_output,
  col.names = c('Model', 'AIC', 'AUC', "Train", "Test", 'Acc.'), 
  caption = "Comparison of selected model evaluations, wherein $\\eta_i = \\text{logit}(\\mu_i)$, and Acc. refers to the model accuracy on test data.\\label{tab:output-model-selection-table}",
  escape = FALSE,
  longtable=F
) %>% column_spec(1, width = "7em") %>% add_header_above(c(" " = 3, "RMSE" = 2, " " = 1)) %>% row_spec (0, bold = T)
```

We selected the model based on AIC, which enabled us to balance model complexity and model fit. This model is *change factors*
$$\text{logit}(\mu_i) \sim \beta_0 + \beta_1a + \beta_2a^2 + \beta_3q + \alpha^{ms}_j + \alpha^{u}_k + \alpha^{o}_l + \alpha^{t}_m + \alpha^{s}_n$$
where $j \in \{Married,Not\,Married\}$, $k \in \{Urban,Not\,Urban\}$, $l \in \{White,...,Other\}$, $n \in \{Male,Female\}$ and $m \in \{Further\,Education,...,No\,qualification\}$.

To evaluate the predictive performance of our final model using our test data, Figure \ref{fig:output-calibration-chart} demonstrates the predicted probability of each ‘probability bin’ against the mean actual outcomes. As we can see the calibration curve closely follows the line $y = x$, which is indicative of a well-calibrated model.
*This model doesn't predict high values...*

```{r output-calibration-chart, include = T, fig.width=4, fig.height=4, fig.align='center', fig.cap="Calibration chart for Binomial model"}
create_binom_model_calibration_chart(q2_model)
```

### Which lifestyle habits are associated with systolic blood pressure?

We chose to model the systolic blood pressure (BP) using the Inverse-Normal distribution with a $1/\mu_i^2$ link function. As we noted before this variable has a lot of outliers, is right-skewed and strictly positive, making this distribution a good choice. We also tested a Log-Normal distribution, a Normal distribution with identity link and a Gamma distribution with an inverse link but found that the Inverse-Normal distribution was able to account for the higher values of BP the best when we compared the Q-Q plots. The data we used to fit this model was the same training data set as the Binomial model. We filtered out *NA* values of BMI and BP as we only want to consider respondents that had lab measurements taken, leaving us with `r NROW(filter(train16plus , BMIVal <= 54, !is.na(omsysval), !is.na(BMIVal)))` observations.

We studied the relationship between both age and BMI with BP, shown in Figure \ref{fig:output-relationship-plots}. There was a quadratic relationship between BMI and BP so we decided to include a $bmi^2$ term in our model. To account for possible dependencies between variables in the data, we tried fitted models with a combination of different interaction terms and found three that were likely significant. These were an interaction between BMI & Age [@AgeBMI], BMI & gender [@SexBMI] and Age & Sex [@AgeSex], which are all existing areas of research.

```{r output-relationship-plots, include = T, fig.height=5, fig.width=12, fig.cap="Relationship of BMI and Age with Mean Systolic Blood Pressure"}
p1 <- create_relationship_plots('age_estim', labels = list(x = "Estimated Age (yrs)"))
p2 <- create_relationship_plots('BMIVal', labels = list(x = "Body Mass Index (kg/m^2)"))

cowplot::plot_grid(p1, p2)
```

To determine the predictors in the final model, we used a stepwise approach starting with the full model and eliminating variables based on AIC. The final model selected was
$$MODEL$$

The Q-Q plot in Figure \ref{fig:output-qq-plot} shows a good fit to the distribution and, despite some deviation at both ends of the scale, the model can capture the outliers more accurately than other distributions we tried. On our testing dataset we achieve a RMSE of 14.3mm Hg, which is relatively small considering the spread of the variable.

```{r output-qq-plot, include = T, fig.height=4, fig.width=4, fig.align='center', fig.cap="Q-Q plot of Inverse-Normal model residuals"}
create_qq_plot(q3_model)
```

We found that, on average, young females have lower blood pressure than young men but as they age, their blood pressure increases at a faster rate. Controlling for other lifestyle choices included in the model, a female’s blood pressure can be expected to exceed an equivalent male’s at around 72 years old. Figure \ref{fig:output-effect-plots-age} shows this relationship.
One of the biggest influences on BP was smoking status, and we found smoking was associated with higher blood pressure for both males and females, also shown in Figure \ref{fig:output-effect-plots}. This effect is largest for males and a typical male can expect a `r round(filter(cig_sex_effects, group == "Male")$percentage_change, digits = 2)`% increase in BP by taking up smoking. 

```{r output-effect-plots-age, include = T, fig.height=4, fig.width=4, fig.cap="Marginal effects of Age on Systolic Blood Pressure"}
create_effects_plot(q3_model, c('age_estim', 'Sex'), labels = list(x = 'Estimated Age', y = 'Predicted Mean Systolic Blood Pressure (mm Hg)'))
```

```{r output-effect-plots, include = T, fig.height=5, fig.width=12, fig.cap="Marginal effects of Smoking Status and BMI on Systolic Blood Pressure"}
p1 <- create_effects_plot(q3_model, c('cigsta3_19', 'Sex'), labels = list(x = 'Smoking Status', y = 'Predicted Mean Systolic Blood Pressure (mm Hg)'))
p2 <- create_effects_plot(q3_model, c('BMIVal', 'Sex'), labels = list(x = 'BMI', y = 'Predicted Mean Systolic Blood Pressure (mm Hg)'))

cowplot::plot_grid(p1, p2)
```

Drinking was also related to higher BP, and we observe a linear relationship in Figure \ref{fig:output-effect-plots-alc} with the number of days that alcohol was consumed in the previous week. On average, one extra day of drinking led to an increase of `r round(mean_drinking_change, 2)`` mm Hg.

```{r output-effect-plots-alc, include = T, fig.height=5, fig.width=12, fig.cap="Marginal effects of alcohol consumption on Systolic Blood Pressure"}
create_effects_plot(q3_model, c('d7many3_19', 'Sex'), labels = list(x = 'Number of Days Alcohol Consumed in the Previous Week', y = 'Predicted Mean Systolic Blood Pressure (mm Hg)'))
```


## Results/Conclusion

Our analysis showed that alcohol consumption is extremely common among UK adults, with approximately `r round(100 * overall_drinking$p_hat, digits = 1)`% being consumers, while smoking and vaping rates are lower at `r round(100 * overall_smoking$p_hat, digits = 1)`% and `r round(100 * overall_ecigs$p_hat, digits = 1)`%, respectively. Older males show the highest tendencies for alcohol consumption, with ‘frequent’ drinking the most prevalent among males aged 65-74. Unlike ‘frequent’ alcohol consumption, the prevalence of smoking decreases with age. Individuals aged 16-24 appear to be the worst offenders when it comes to smoking cigarettes, indicating a significant issue within youth culture. Moreover, we found an interesting relationship between deprivation levels and smoking and drinking behaviours. Smoking prevalence seemed to increase as deprivation levels decrease, while alcohol consumption appeared to do the opposite.

To help us uncover the underlying socio-economic factors that may drive the prevalence of smoking, we first looked at the most ‘comparable’ respondent type in our dataset. This ‘respondent’ is a white, single male who has no qualifications and lives in an urban area. We found that the probability of our hypothetical respondent being a smoker is approximately 25% *Where is this from?* (notably higher than the population average of `r round(100 * overall_smoking$p_hat, digits = 1)`). *Maybe worth talking about confidence intervals here - is value outside 95%* The only socio-economic variables to certainly increase this probability is the deprivation level our respondent falls under. The rest of the socio-economic variables we have access to, appear to decrease the likelihood of smoking. For example, if our respondent is any of the following: Asian, black, married, or went on to further education, the chances of them being a smoker is at-least halved.

\clearpage
# References