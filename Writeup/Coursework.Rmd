---
output: 
  pdf_document:
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    extra_dependencies: ["float"]
header-includes:
  - \usepackage{hyperref}
  - \usepackage{array}   
  - \usepackage{caption}
  - \usepackage{graphicx}
  - \usepackage{multirow}
  - \usepackage{hhline}
  - \usepackage{calc}
  - \usepackage{tabularx}
  - \usepackage[para,online,flushleft]{threeparttable} 
  - \DeclareMathOperator{\logit}{logit}
  - \DeclareMathOperator{\var}{var}
geometry: margin=0.1in
pagenumbers: no
fontsize: 11pt
endnote: no
title: "Analysis of Health Survey for England (HSE) 2019"
author: "Candidate Numbers: 24226, 14925, 23766, 24170."
date: "`r format(Sys.time(), '%B %d, %Y')`"
bibliography: bibliography.bib
abstract: "This report provides an analysis of data related to health, age, socio-economic factors and lifestyle habits in adults (from the age of 16) from the population in England, derived from the Health Survey for England 2019. Please note, no generative AI technology was utilized in the creation of this report or the subsequent data analysis presented herein. All findings and conclusions are derived from human-driven methodologies."
nocite: '@*'
link-citations: true
classoption:
- twocolumn
---

<!-- Remove page numbers -->

\pagenumbering{gobble}

```{r setup, include=F}
knitr::opts_chunk$set(include = F, echo = F, message = F, warning = F, fig.pos = "H", out.extra = "")
```

<!-- Put all code at start and only call plots when we need them in line -->

```{r initial data filtering and splitting}
library(dplyr)
library(haven)
library(ggplot2)
library(broom)
library(pROC)
library(caret)
library(kableExtra)

set.seed(200)

load("~/w_MA30091/Coursework/MA30091/Writeup/hsesub.Rdata")

fct_variables <- c(
  'Sex', 'Age35g', 'ag16g10', 'topqual2', 'urban14b', 'origin2', 'marstatD', 'GOR1', 'cigsta3_19', 'NDPNow_19', 'drinkYN_19', 'dnoft_19'
)

# filter to over 16s, relabel all factors
sd16plus <- subdat %>% 
  filter(Age35g >= 7 & !is.na(Age35g)) %>% 
  # Remove duplicated entries
  distinct(pick(!c(SerialA)), .keep_all = T) %>% 
  mutate(
    across(
      all_of(fct_variables), 
      # drop excess factor levels
      ~ droplevels(factor(as.factor(.x), levels = attr(subdat[[cur_column()]], 'labels'), labels = names(attr(subdat[[cur_column()]], 'labels'))))
    ), 
    across(!all_of(fct_variables), as.numeric)
  ) %>% 
  mutate(
    # Grouping variables
    marstatD = as.factor(
      case_when(
        grepl('Married', marstatD) ~ 'Married', 
        !is.na(marstatD) ~ 'Not Married',
        T ~ NA_character_
      )
    ),
    topqual2 = as.factor(
      case_when(
        grepl('Higher ed|FT Student', topqual2) ~ 'Higher Education', 
        grepl('NVQ4', topqual2) ~ 'Further Education',
        grepl('NVQ3', topqual2) ~ 'A-Level equiv.',
        grepl('NVQ1|NVQ2', topqual2) ~ 'GCSE equiv.',
        T ~ as.character(topqual2)
      )
    ),
    dnoft_19 = as.factor(
      case_when(
        dnoft_19 %in% c('Almost every day', 'Five or six days a week', 'Three or four days a week') ~ "Frequent",
        dnoft_19 %in% c('Once or twice a week', 'Once or twice a month') ~ "Occasional",
        dnoft_19 %in% c('Once every couple of months', 'Once or twice a year', 'Not at all in the last 12 months') ~ "Rarely",
        T ~ NA_character_
      )
    ),
    urban14b = as.factor(
      case_when(
        grepl('Town', urban14b) ~ 'Rural', 
        T ~ as.character(urban14b)
      )
    ),
    origin2 = as.factor(
      case_when(
        grepl('Mixed', origin2) ~ 'Multiple',
        grepl('other', origin2) ~ 'Other',
        T ~ as.character(origin2)
      )
    ),
    NDPNow_19 = as.factor(
      case_when(
        grepl('Both|E-cigarettes', NDPNow_19) ~ 'Smokes E-cigarettes',
        grepl('None|Other', NDPNow_19) ~ 'Doesn\'t smoke E-cigarettes',
        T ~ NA_character_
      )
    ),
    
    # Define new variables
    
    current_smoker = as.numeric(cigsta3_19 == "Current cigarette smoker"),
    age_estim =
      case_when(
        Age35g != "90+" ~ purrr::map2_dbl(as.numeric(substr(Age35g,0,2)), as.numeric(substr(Age35g,4,5)), \(x, y) mean(c(x, y))),
        !(is.na(Age35g)) ~ 92.5,
        T ~ NA_real_
      )
  )
```

```{r proportion bar plot function}
create_proportion_bar_plot <- function(group_variable, facet_variable, plotting_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(
      !if_any(all_of(plotting_variable), is.na)
    ) %>% 
    group_by(
      across(all_of(c(group_variable, facet_variable, plotting_variable)))
    ) %>% 
    summarise(n = n(), .groups = 'drop_last') %>% 
    mutate(proportion = n / sum(n))
  
  ggplot(data, aes(x = !!sym(group_variable), y = proportion, fill = !!sym(plotting_variable))) +
    geom_bar(stat = "identity", position = "dodge") +
    facet_wrap(as.formula(paste("~", facet_variable)), scales = "free_x") +
    scale_fill_brewer(palette = "Pastel1", name = labels$legend.title) +
    labs(x = labels$x, y = labels$y) +
    scale_y_continuous(labels = scales::percent) +
    guides(
      fill = guide_legend(title.position = 'top', title.hjust = 0.5, title.theme = element_text(face = 'bold'))
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = 'bottom',
      strip.text = element_text(face = 'bold', size = 12),
      legend.text = element_text(size = 7), 
      legend.key.size = unit(0.4, 'cm')
    )
}
```

```{r stacked bar plot function}
create_stacked_bar_plot <- function(group_variable, plotting_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(
      !if_any(all_of(plotting_variable), is.na)
    ) %>% 
    group_by(
      across(all_of(c(group_variable, plotting_variable)))
    ) %>% 
    summarise(n = n(), .groups = 'drop_last') %>% 
    mutate(proportion = n / sum(n))
  
  ggplot(data, aes(x = !!sym(group_variable), y = proportion, fill = !!sym(plotting_variable))) +
    geom_bar(stat = "identity", position = "stack") +
    scale_fill_brewer(palette = "Pastel3", name = labels$legend.title) +
    scale_y_continuous(labels = scales::percent) +
    guides(
      fill = guide_legend(title.position = 'top', title.hjust = 0.5, title.theme = element_text(face = 'bold'))
    ) +
    labs(x = labels$x, y = labels$y) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      legend.position = 'bottom', 
      legend.text = element_text(size = 6), 
      legend.key.size = unit(0.4, 'cm')
    )
}
```

```{r confidence interval calculation}
# function to calculate the confidence intervals
calculate_binomial_ci <- function(dat_vec, weights = rep(1, length.out = length(dat_vec)), alpha = 0.05) {
  dat_vec <- as.numeric(dat_vec)
  
  n <- length(dat_vec)
  
  p_hat <- sum(dat_vec * weights) / sum(weights)
  
  var_est <- p_hat * (1 - p_hat) / sum(weights)
  
  ci <- p_hat + c(-1, 1) * qnorm(1 - alpha / 2) * sqrt(var_est)
  
  list(n = n, p_hat = p_hat, alpha = alpha, ci = ci, var_est = var_est)
}

# Initial calculations of prevelance across the three categories
# here we use full dataset, not split into test and train
drinking_na <- is.na(sd16plus$drinkYN_19)
overall_drinking <- calculate_binomial_ci(sd16plus$drinkYN_19[!drinking_na] == 'Yes', sd16plus$wt_int[!drinking_na])

smoking_na <- is.na(sd16plus$cigsta3_19)
overall_smoking <- calculate_binomial_ci(sd16plus$cigsta3_19[!smoking_na] == 'Current cigarette smoker', sd16plus$wt_int[!smoking_na])

ecig_na <- is.na(sd16plus$NDPNow_19)
overall_ecigs <- calculate_binomial_ci(sd16plus$NDPNow_19[!ecig_na] == 'Smokes E-cigarettes', sd16plus$wt_int[!ecig_na])

# Creating table output
prevelance_table <- tibble(
  Category = c('Drinking', 'Smoking', 'Smoking E-cigarettes'),
  Estimate = c(overall_drinking$p_hat, overall_smoking$p_hat, overall_ecigs$p_hat),
  LowerCI = c(overall_drinking$ci[1], overall_smoking$ci[1], overall_ecigs$ci[1]),
  UpperCI = c(overall_drinking$ci[2], overall_smoking$ci[2], overall_ecigs$ci[2])
) %>% 
  mutate(
    CI = glue::glue('({100 * signif(LowerCI, digits = 3)}%, {100 * signif(UpperCI, digits = 3)}%)'),
    Estimate = paste0(100 * signif(Estimate, digits = 3), '%')
  ) %>% 
  select(-c(LowerCI, UpperCI))
```

```{r confidence interval plots}
create_confidence_int_plot <- function(group_variable, facet_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(!if_any(c(cigsta3_19, drinkYN_19, NDPNow_19), is.na)) %>% 
    group_by(
      across(all_of(c(group_variable, facet_variable)))
    ) %>% 
    summarise(
      cig = list(cigsta3_19 == 'Current cigarette smoker'),
      alc = list(drinkYN_19 == 'Yes'),
      ecig = list(NDPNow_19 == 'Smokes E-cigarettes'),
      wt_int = list(wt_int), 
      .groups = 'drop'
    ) %>% 
    mutate(
      across(c(cig, alc, ecig), ~ purrr::map2(.x, wt_int, calculate_binomial_ci))
    ) %>% 
    select(-c(wt_int)) %>%
    tidyr::pivot_longer(
      cols = c(cig:ecig), names_to = 'category', values_to = 'summary'
    ) %>% 
    mutate(
      p_hat = purrr::map_dbl(summary, \(x) x$p_hat),
      lower = purrr::map_dbl(summary, \(x) x$ci[1]),
      upper = purrr::map_dbl(summary, \(x) x$ci[2])
    ) %>% 
    select(-c(summary))
  
  ggplot(data = data, aes(x = !!sym(group_variable), y = p_hat, ymin = lower, ymax = upper, group = category, fill = category)) +
    geom_bar(stat = 'identity', position = position_dodge(width = 1)) +
    geom_errorbar(width = 0.5, position = position_dodge(width = 1)) +
    facet_wrap(as.formula(paste('~ ', facet_variable))) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = labels$x, y = labels$y) +
    scale_fill_brewer(
      palette = "Pastel1", name = labels$legend.title, labels = c("ecig" = "Smoking E-Cigarettes", "cig" = "Smoking", 'alc' = 'Drinking')
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = 'bold', size = 12), legend.position = 'bottom'
    )
}
```

```{r splitting dataset into test and train}
# split data into test/train
set.seed(200)
train16plus <- sd16plus %>% sample_frac(0.8) 
test16plus <- sd16plus %>% anti_join(train16plus, by = c('SerialA'))
```

```{r summary of data set}
variable_na_table <- sd16plus %>% 
  select(-c(SerialA, current_smoker, age_estim)) %>% 
  summarise(
    across(everything(), ~ sum(is.na(.x)))
  ) %>% 
  tidyr::pivot_longer(
    cols = everything(), names_to = 'Variable', values_to = 'SumNA'
  ) %>% 
  # Can filter out variables with 0 NAs for table?
  filter(SumNA != 0) %>%
  mutate(PercNA = paste0(100 * signif(SumNA / NROW(train16plus), digits = 3), '%')) %>% 
  arrange(desc(SumNA))

variable_na_table_train <- train16plus %>% 
  select(-c(SerialA, current_smoker, age_estim)) %>% 
  summarise(
    across(everything(), ~ sum(is.na(.x)))
  ) %>% 
  tidyr::pivot_longer(
    cols = everything(), names_to = 'Variable', values_to = 'SumNA'
  ) %>% 
  # Can filter out variables with 0 NAs for table?
  filter(SumNA != 0) %>%
  mutate(PercNA = paste0(100 * signif(SumNA / NROW(train16plus), digits = 3), '%')) %>% 
  arrange(desc(SumNA))
```

```{r fitting q2 model}
get_binom_model_diagnostics <- function(formula) {
  fit <- glm(formula, data = train16plus, family = binomial)
  
  aic <- AIC(fit)
  
  # predicting train values
  pred_train <- predict(fit, newdata = train16plus, type = 'response')
  
  train_rmse <- sqrt(mean((train16plus$current_smoker - pred_train) ^ 2, na.rm = T))
  
  # predicting test values
  pred_test <- predict(fit, newdata = test16plus, type = 'response')
  
  auc <- as.numeric(auc(response = test16plus$current_smoker, predictor = pred_test))
  
  test_rmse <- sqrt(mean((test16plus$current_smoker - pred_test) ^ 2, na.rm = T))
  
  accuracy <- mean(round(pred_test) == test16plus$current_smoker, na.rm = T)
  
  tibble(
    model = list(fit), link = 'logit', family = 'binomial', aic = aic, auc = auc, train_rmse = train_rmse, test_rmse = test_rmse, accuracy = accuracy
  )
}

# Define the model formulas
binom_model_formulas <- list(
  glm2 = current_smoker ~ age_estim + I(age_estim ^ 2) + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm3 = current_smoker ~ age_estim + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm4 = current_smoker ~ Age35g + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm5 = current_smoker ~ ag16g10 + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex
)

# loop over formulas
model_diagnostics <- lapply(binom_model_formulas, get_binom_model_diagnostics) %>% bind_rows()

# selected model
q2_model <- model_diagnostics$model[[which.min(model_diagnostics$aic)]]
```

```{r create q2 model selector table}
model_specs <- c(
  "$\\eta_i \\sim a_i + a_i^2 + ms_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\eta_i \\sim a_i + ms_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\eta_i \\sim a_i^{(5)} + ms_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\eta_i \\sim a_i^{(10)} + ms_i + q_i + u_i + o_i + t_i + s_i$"
)

model_table_output <- model_diagnostics %>% 
  select(aic, auc, train_rmse, test_rmse, accuracy) %>% 
  mutate(
    formula = model_specs, 
    aic = round(aic, digits = 1),
    across(c(auc:accuracy), ~ round(.x, digits = 3)),
    .before = 1
  )
```

```{r calibration chart function}
create_binom_model_calibration_chart <- function(fit) {
  pred <- predict(fit, test16plus, type = 'response')
  
  actual <- test16plus$current_smoker
  
  ggplot(mapping = aes(x = pred, y = actual)) +
    stat_summary_bin(fun = "mean", bins = 10, geom = "point") +  # Bin and plot mean actual per bin
    stat_summary_bin(fun = "mean", bins = 10, geom = "line", aes(group = 1)) +  # Connect points with lines
    labs(x = "Predicted Probability", y = "Mean Actual Outcome") +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
    xlim(c(0, 1)) +
    ylim(c(0, 1)) +
    theme_minimal()
}
```

```{r distribution plots}
create_distribution_plot <- function(variable, label) {
  ggplot() +
  geom_violin(
    data = sd16plus, aes(y = !!sym(variable), x = as.factor(1)),
    scale = "width", alpha = 0.5, color = "black", fill = "blue"
  ) +
  geom_boxplot(
    data = sd16plus, aes(y = !!sym(variable), x = as.factor(1)),
    width = 0.2,
    fill = "white", 
    outlier.shape = 3, 
    outlier.colour = "red", 
    outlier.alpha = 1, 
    outlier.size = 4
  ) +
  ylab(label) +
  theme_minimal() +
  coord_flip() +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
}
```

```{r fitting q3 model}
q3_model <- glm(
  formula = omsysval ~ cigsta3_19 + age_estim + marstatD + urban14b + BMIVal + I(BMIVal ^ 2) + Sex + d7many3_19 + BMIVal:Sex + age_estim:Sex + BMIVal:age_estim,
  family = inverse.gaussian,
  # Filter out BMI outliers and NA omsysval
  data = train16plus %>% filter(BMIVal <= 54, !is.na(omsysval), !is.na(BMIVal))
)
```

```{r qqplot function}
create_qq_plot <- function(fit) {
  pred <- rstandard(fit)
  
  ggplot(mapping = aes(sample = pred)) +
    stat_qq() +
    stat_qq_line(linetype = 'dashed', col = 'red') +
    theme_minimal() +
    labs(x = "Theoretical Quantiles", y = "Std. Pearson Residuals")
}
```

```{r relationship plots for q3}
create_relationship_plots <- function(variable, labels) {
  ggplot(data = train16plus, aes(x = !!sym(variable), y = omsysval)) +
    geom_point() +
    geom_smooth() +
    labs(y = "Omron Valid Mean Systolic Blood Pressure (mmHg)", x = labels$x) +
    theme_minimal()
}
```

```{r some model plots for q3}
# Calculate RMSE
pred <- predict(q3_model, test16plus, type = 'response')
q3_rmse <- sqrt(mean((test16plus$omsysval - pred) ^ 2, na.rm = T))

# Effects plot function
create_effects_plot <- function(fit, terms, labels = list()) {
  sjPlot::plot_model(fit, type = "pred", terms = terms) +
    labs(x = labels$x, y = labels$y) +
    theme_minimal() +
    theme(plot.title = element_blank(), legend.position = 'bottom', legend.title = element_blank(), axis.title = element_text(size = 8))
}

# Calculate average drinking change
mean_drinking_change <- tibble(ggeffects::ggpredict(model = q3_model, terms = c('d7many3_19'))) %>% pull(predicted) %>% diff() %>% mean()

# Percentage changes for cigarettes calculations
cig_sex_effects <- tibble(ggeffects::ggpredict(model = q3_model, terms = c('cigsta3_19', 'Sex'))) %>% 
  mutate(x = gsub(" .*", "", x)) %>% 
  filter(x != "Ex-regular") %>% 
  select(x, predicted, group) %>% 
  tidyr::pivot_wider(id_cols = group, names_from = x, values_from = predicted) %>%
  mutate(
    percentage_change = 100 * (Current - Never) / Never
  )

# Age and gender effects
age_sex_effects <- tibble(ggeffects::ggpredict(model = q3_model, terms = c('age_estim', 'Sex')))
```

```{r deprivation summary}
# Create deprivation summary
deprivation_smoking_summary <- sd16plus %>% 
  filter(!if_any(c(cigsta3_19, drinkYN_19, NDPNow_19), is.na)) %>% 
  group_by(
    qimd19
  ) %>% 
  summarise(
    cig = list(cigsta3_19 == 'Current cigarette smoker'),
    wt_int = list(wt_int), 
    .groups = 'drop'
  ) %>% 
  mutate(
    summary = purrr::map2(cig, wt_int, calculate_binomial_ci),
    p_hat = purrr::map_dbl(summary, \(x) x$p_hat),
    lower = purrr::map_dbl(summary, \(x) x$ci[1]),
    upper = purrr::map_dbl(summary, \(x) x$ci[2])
  )
```

<!-- Start of write-up -->

\clearpage

# Summary

In England, smoking, "vaping" and alcohol consumption are widespread habits among adults, particularly younger adults. In fact, it is estimated that around 13.9% of adults in England identified as cigarette smokers [@1ONS], and a similar study found that there were 10.9 alcohol-related deaths per 100,000 people living in England in 2019 [@2ONS]. Thus, it is crucial to be aware of the predictors and consequences of these habits, which is the motivation for this analysis.

We conducted this analysis on a subset containing 8,204 adults living in England (ages 16+), who were interviewed in their homes about their demographics and their smoking and drinking habits as part of the Health Survey for England (HSE) 2019. 4,947 of these participants who consented to an at-home nurse visit had vitals such as blood pressure, weight and height measured. We investigated which features of a participant are associated with smoking habits, and which habits are associated with high blood pressure.

We found alcohol consumption to be the most prevalent lifestyle habit under investigation. Older males were found to drink the most, especially those aged 65-74. Also, smoking tended to be more prevalent in areas of greater deprivation, whilst alcohol consumption was found to be more prevalent in less deprived areas. Socio-economic factors played an important role in the likelihood of smoking, with females 25% less likely to be smokers than males. Ethnicity also played a great role, as being Black or Asian decreased the likelihood of smoking by more than 70% and 65%, respectively. Females were much less likely to experience hypertension in comparison to males. However, systolic blood pressure levels were positively correlated with age and how often the respondent drinks alcohol, regardless of gender.

## Introduction

The mechanisms which drive lifestyle habits are part of a complex and ever-changing field in behavioural psychology. What is known, however, is that such habits are driven by cues and cravings [@SmokeCue; @DrinkCue]. The HSE 2019 captures demographic and socioeconomic characteristics that have the potential to make such cues more visible and cravings harder to resist. For example, living in a region where smoking is more prevalent or not having a husband/wife for an accountability partner to help you quit or resist these habits [@AccountPartner].

In this report, we will use weighting variables to estimate prevalence of cigarette, e-cig, and alcohol users in our population, and compare it with the larger population of adults in England. We will then attempt to identify associations with a participant's current smoking status, explore whether predictive modelling can be used to identify smokers with a high accuracy, and investigate which lifestyle habits are associated with increased values of systolic blood pressure. Such an understanding would be crucial in enabling healthcare providers to implement preventative care for people at risk of developing hypertension.

# Methodology

## Exploratory Analysis

The full HSE 2019 cross-sectional data set contains 10,299 observations across thousands of variables [@Main], but we only studied patients over the age of 16 among key variables. Our subset included 8,204 participants and 19 variables, which are described in Table \ref{tab:output-var-table}.

```{r outputvartable, include = T}

n = c("SerialA","wt\\_int","Sex","(D) Age35g","(D) ag16g10","(D) topqual2","(D) marstatD","(D) qimd19","(D) urban14b","(D) origin2","(D) cigdyal\\_19","(D) cigsta3\\_19","(D) NDPNow\\_19","(D) DrinkYN\\_19","dnoft\\_19","(D) d7many3\\_19","(D) GOR1","(D) BMIval","(D) omsysval", "(D) smoking\\_status", "(D) age\\_estim") 
s = c("Respondent serial number","Weight of observation","Respondent sex (M/F)                         ","Respondent age grouped in 5 year bands for 16+","Respondent age grouped in 10 year bands for 16+","Highest level qualification","Marital status","IMD score (a measure of deprivation)","Level of rurality","Grouped ethnic category","$\\#$ of cigarettes smoked per day","Smoking status (Reg / Ex-Reg / Never-Reg)","Use of E-cigarettes and or NDPs","Alcohol consumed in the last 12 months","Frequency of alcohol consumed in the last 12 months (grouped)","$\\#$ of days alcohol was consumed in the last week ","Government region office number","Valid BMI measurement (weight estimated if $\\>$ 130kg) ","Valid mean systolic blood pressure", "Current smoking status (binary)", "Estimated age")
b = c("ID", "w", "$s$", "$a^{(5)}$","$a^{(10)}$", "$t$", "$ms$", "$q$", "$u$", "$o$","$n^{cig}$", "$cig$", "$ndp$", "$alc$","f", "$n^{alc}$", "$g$", "$bmi$", "$sbp$", "$S$", "$a$") 
df = data.frame(n, s, b)

kbl(
  df, "latex", 
  col.names = c('Variable', 'Definition', 'Notation'), 
  caption = "Summary of the analysis variables used in our report. (D) indicates that a variable was derived.\\label{tab:output-var-table}",
  longtable=F, escape = F) %>% column_spec(2, width = "11em") %>% column_spec(1, width = "7em") %>% row_spec (0, bold = T) %>% kable_styling(font_size = 8)
```

### Duplicates

We found 36 pairs of observations with exactly equal variables (excluding ID variables and lab measurements), but we did not remove these from our analysis because the supporting documentation didn't state a protocol for repeated visits. We assumed these were genuine observations from different participants and thus included them in our dataset. However, there were 3 pairs of observations that had duplicate lab variables also. Due to the high precision of measurements, we believed these to be true duplicates and removed one observation from each of the three pairs, resulting in a dataset of `r NROW(sd16plus)` observations.

### Dichotomy of Factors

All variables were originally coded as numeric in our dataset, so we recoded these to factor variables accordingly. Some of the variables used for analysis were dichotomised by us for easier interpretation. We coded a binary variable indicating current smoking status, which served as a response variable. Also, we dichotomised urbanity into two levels being 'Rural' and 'Urban', and finally marital status into 'Married' and 'Not Married'. We grouped respondent's level of education into 'Higher Education', 'Further Education', 'A-Level equiv.', 'GCSE equiv.', 'No qualification' and 'Foreign/other', and we grouped alcohol frequency into "Frequent", "Occasional" and "Rarely" based on the response to the question "How often did you consume alcohol in the last 12 months?".

### Missingness

```{r outputnatable, include = T}
kbl(
  variable_na_table, 
  col.names = c('Variable', 'Missing Values', '% Missing'), 
  caption = "Missing values in the training dataset\\label{tab:output-na-table}",
  longtable=F) %>% row_spec (0, bold = T) %>% kable_styling(font_size = 9)
```

There is significant missingness in the lab values, as shown in Table \ref{tab:output-na-table}. These can be explained by the fact additional consent was needed from the participant to allow a nurse visit. One variable with a substantial amount of missing data was the frequency of drinking in the last 12 months, which due to the retrospective and sensitive nature of the question could be explained by either recall bias or a participant's refusal to answer. As a result, we decided to remove this variable from analysis in favour of a binary variable which simply states whether the respondent has drunk alcohol in the last 12 months. Education level, marital status and ethnicity are the only socioeconomic variables with any missing entries, with `r filter(variable_na_table, Variable == 'topqual2')$SumNA` observations (`r filter(variable_na_table, Variable == 'topqual2')$PercNA` of the data) missing at least one of the three. These were not necessary for identifiability and as they are sensitive, we did not expect every participant to answer these questions. Therefore, we did not remove these observations.

### Outliers and Data Issues

We attempted to determine whether the two lab measurement variables contained potential outliers, and as can be seen in Figure \ref{fig:output-distribution-plots}, there were many outliers for BMI. We note that calculated BMI used self-estimated weight from the participant if this weight exceeded 130kg. Additionally, weight measurements were taken in inconsistent environments such as on different flooring in the participants' homes which is known to impact measurement accuracy [@Weight]. We believed this could have explained the extremely high BMI values in the range of 54.82 to 73.49. We coded such values as missing in the analysis dataset, but kept the observation.

The readings for systolic blood pressure were collected by taking an average of three readings, each five minutes apart, performed by a trained nurse who had to declare each reading to be valid. For this reason, it seemed highly unlikely that these readings were mistakes, and so we included them in our analysis. The measurement device used has been validated for use in this environment [@Omron]. We did, however, note that values of systolic blood pressure that were this consistently high (\>140mmHg) were indicators for hypertensive crisis, and so a part of our population may have serious underlying health conditions that could affect the generalisability of our findings [@heart].

```{r output-distribution-plots, include = T, fig.height=4, fig.width=10, fig.cap="Distribution of BMI and Mean Systolic Blood Pressure"}
p1 <- create_distribution_plot('omsysval', 'Omron Valid Mean Systolic Blood Pressure (mmHg)') +
  geom_hline(yintercept = c(130, 140, 180), colour = c("yellow", "orange", "red"), size = 0.5) +
  geom_text(
    aes(x = 0.4, y = c(129.9, 139.9, 179.9), label = c("Hypertension (S1)", "Hypertension (S2)", "Hypertensive Crisis")), 
    color = "black", angle = 90, size = 3.5, vjust = 0, hjust = 0
  )
p2 <- create_distribution_plot('BMIVal', 'Body Mass Index (kg/m^2)') +
  geom_hline(yintercept = c(18.5, 25, 30), colour = c("orange", "orange", "red"), size = 0.5) +
  geom_text(
    aes(x = 0.4, y = c(18.4, 24.9, 29.9), label = c("Underweight", "Overweight", "Obese")), 
    color = "black", angle = 90, size = 3.5, vjust = 0, hjust = 0
  )

cowplot::plot_grid(p1, p2, nrow=2)
```

```{r output deprivation plot, include = F, fig.width=10, fig.height=4, fig.cap="Drinking, smoking and E-cig status proportions by level of deprivation"}
p1 <- create_stacked_bar_plot('qimd19', 'cigsta3_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'Drinking Status'))
p2 <- create_stacked_bar_plot('qimd19', 'dnoft_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'Smoking Status'))
p3 <- create_stacked_bar_plot('qimd19', 'NDPNow_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'E-cig Status'))

p1
p2
p3
```

# Analysis

### What is the prevelence of drinking, smoking and E-cig usage?

To calculate the prevalence of these three habits we assumed each of the $n$ observations, $x_1,…,x_n$ , to be independent, identically distributed (iid) random variables (RVs) where $x_i \sim Bern(p)\, \forall i=1,…,n$ and $p$ denotes the probability of a habit being present for the given observation.

We used the household-level weighting variable to calculate a weighted Maximum Likelihood Estimate (MLE) of $p$. That is, letting $w_i$ denote the weight of the $i^{th}$ observation, we altered the standard likelihood function of a Bernoulli distribution as below: $$L(p|\textbf{x}) = \prod_{i = 1}^{n} (p^{x_i}(1-p)^{1-x_i})^{w_i}$$ From this, we calculated our weighted MLE as $\widehat{p} = \frac{\sum_{i=1}^{n} x_iw_i}{\sum_{i=1}^{n} w_i}$. It can also be shown that the MLE has variance given by $\text{var}(p)=\frac{p(1-p)}{\sum_{i=1}^{n}w_i}$, which we estimated using $\widehat{p}$. We used large sample properties of the MLE to get a normal approximation and estimated 95% confidence intervals for each habit, which are shown in Table \ref{tab:output-estimates-table}.

```{r outputestimatestable, include = T}
kbl(
  prevelance_table, 
  col.names = c('Habit', 'Estimate', 'C.I.'), 
  caption = "Estimates and 95\\% Confidence Intervals for \\% of Population\\label{tab:output-estimates-table}",
  longtable=F
) %>% row_spec (0, bold = T) %>% kable_styling(font_size = 9)
```

We found that the e-cigarette usage among adults is relatively low, making it challenging to dissect any significant trends within the data. However, since drinking and smoking were so prevalent among the respondents, we had sufficient data to identify any potential trends even within smaller groups of our sample.

Next, we worked to uncover factors that may have associations with smoking prevalence. We started with the demographic factors of age and gender, plotting the smoking prevalence across combinations of these groups to identify any patterns. Figure \ref{fig:output-prevelance-plot} suggests a negative correlation between age and the proportion of current cigarette smokers, across both genders. Interestingly, the proportion of males who quit smoking in later-life was much greater than that of females (75yrs+; M: 50%, F: 31%).

```{r output-smoking-drinking-age-plot, include = T, fig.width=12, fig.height=5, fig.cap="Smoking and drinking status proportions by age group and gender"}
p1 <- create_proportion_bar_plot('ag16g10', 'Sex', 'cigsta3_19', labels = list(x = 'Age Group', y = 'Proportion', legend.title = 'Smoking Status'))
p2 <- create_proportion_bar_plot('ag16g10', 'Sex', 'dnoft_19', labels = list(x = 'Age Group', y = 'Proportion', legend.title = 'Drinking Status'))

p1
p2
```

```{r output-prevelance-plot, include = T, fig.height=5, fig.width=8, fig.cap="Estimation of the prevelance of habits by age group and gender."}
create_confidence_int_plot('ag16g10', 'Sex', list(x = 'Age Group', y = '% Prevelance In Population', legend.title = "Habit"))
```

Males demonstrated a higher prevalence of drinking across nearly all demographic categories in comparison to females. We observed a positive correlation between smoking and deprivation levels, with `r round(100 * filter(deprivation_smoking_summary, qimd19 == 5)$p_hat, digits = 2)`% of individuals in the most deprived quintile being smokers, a significant increase from `r round(100 * filter(deprivation_smoking_summary, qimd19 == 1)$p_hat, digits = 2)`% in the least deprived.

### How is smoking associated with socioeconomic factors and age?

We reserved 80% of our data to train the model, and used the remaining 20% to test the model, which was made possible due to the large size of our dataset. The training set contained `r NROW(train16plus)` observations and the test set contained `r NROW(test16plus)`. Table \ref{tab:output-testtrain-table} summarises the key variables between the test and train dataset to illustrate that both are representative of the whole dataset. This reduced the risk of overfitting and allowed us to test the predictive power of each model we proposed.

```{r outputtesttraintable, include = T}

n = c("Sex:Male", "Sex:Female", " ", "topqual2:No qualification", "topqual2:GCSE equiv.", "topqual2:A-Level equiv.", "topqual2:Further Education", "topqual2:Higher Education", "topqual2:Foreign/Other", " ", "marstatD:Married", "marstatD:Not Married", " ", "urban14b:Urban", "urban14b:Not Urban", " ", "origin2:White", "origin2:Black", "origin2:Asian","origin2:Multiple", "origin2:Other"," ", "Age(Estimated)") 
s = c("43.5", "56.5", " ", "19.7", "21.2", "14.0", "28.5", "15.9", " 0.7", " ", "55.4", "44.6", " ", "80.3", "19.7", " ", "85.9", " 3.1", " 8.8", " 1.4", " 0.8", "Mean", "51.2")
b = c("45.1", "54.8", " ", "19.8", "20.9", "13.4", "28.4", "16.1", " 1.3", " ", "51.9", "48.1", " ", "81.4", "18.6", " ", "85.8", " 2.9", " 8.7", " 1.7", " 0.9", "Mean", "51.0")
df = data.frame(n, s, b)

kbl(
  df, "latex", 
  col.names = c('Variable:Label', 'Test', 'Train'), 
  caption = "Comparison of the characteristics of the training set compared with the test set.\\label{tab:output-testtrain-table}",
  longtable=F, escape = F) %>% add_header_above(c(" " = 1, "Proportion (%)" = 2)) %>% row_spec (22, bold = T) %>% row_spec (0, bold = T) %>% kable_styling(font_size = 10)
```

To develop a predictive model for identifying smokers, we used the binary variable for current smoking status as a response, with various socioeconomic and demographic factors as predictors. These were selected based on the associations suggested by our prior analysis.

Under the assumption that the age of participants were approximately uniformly distributed within their respective age bands, we defined the estimated age of the $i^{th}$ observation as the midpoint of the participant's respective 5-year age group (taking the estimation of the 90+ category as 92.5), denoted $a_i$. We found that age may represent a somewhat quadratic effect on the probability of smoking, leading us to include a $a_i^2$ term in our model. A comparison of these models are summarised in Table \ref{tab:output-model-selection-table}.

We selected the model based on AIC, which enabled us to balance model complexity and model fit (quantified by likelihood), which further reduced the risk of overfitting. This model is:
\begin{align*}
\text{logit}(\mu_i) \sim \beta_0 + \beta_1a + \beta_2a^2 + \beta_3q + \alpha^{ms}_j + \alpha^{u}_k + \alpha^{o}_l + \alpha^{t}_m + \alpha^{s}_n \\\text{where } j \in \{\text{Married, Not Married}\}, k \in \{\text{Urban, Not Urban}\},\\ l \in \{\text{White,}\ldots\text{,Black}\}, n \in \{\text{Male, Female\} and}\ \\ m \in \{\text{Higher Education,}\ldots\text{, No qualification}\}.
\end{align*}

```{r outputmodelselectiontable, include = T}
kbl(
  model_table_output,
  col.names = c('Model', 'AIC', 'AUC', "Train", "Test", 'Acc.'), 
  caption = "Comparison of selected model evaluations, wherein $\\eta_i = \\text{logit}(\\mu_i)$, and Acc. refers to the model accuracy on test data.\\label{tab:output-model-selection-table}",
  escape = FALSE,
  longtable=F
) %>% column_spec(1, width = "9em") %>% add_header_above(c(" " = 3, "RMSE" = 2, " " = 1)) %>% row_spec (0, bold = T) %>% kable_styling(font_size = 8)
```

To evaluate the predictive performance of our final model using our test data, Figure 4 demonstrates the predicted probability of each 'probability bin' against the mean actual outcomes. As we can see the calibration curve closely follows the line $y = x$, which is indicative of a well-calibrated model.

This model doesn't predict high values due to the low prevalence of smoking within the population. The highest likelihood our model predicts is 63.75% All results should be interpreted with the population average in mind, which is \~16.5%. For example, if the model predicts the likelihood of an individual being a smoker at 33%, said individual is twice as more likely to be a smoker than the average. This effect can be seen in the following calibration chart.

```{r output-calibration-chart, include = T, fig.width=4, fig.height=3, fig.align='center', fig.cap="Calibration chart for Binomial model"}
create_binom_model_calibration_chart(q2_model)
```

```{r output-forest-plot, include = T, fig.height=4, fig.width=8, fig.cap="Forest plot of Odds Ratios for the binomial model"}
# Create df and set reference levels
data <- data.frame(
  Sex = factor(train16plus$Sex),
  age_estim = train16plus$age_estim,
  current_smoker = train16plus$current_smoker,
  marstatD = factor(train16plus$marstatD),
  qimd19 = train16plus$qimd19,
  urban14b = factor(train16plus$urban14b),
  origin2 = factor(train16plus$origin2),
  topqual2 = factor(train16plus$topqual2)
)

reference_levels <- list(
  Sex = "Male",
  marstatD = "Not Married",
  urban14b = "Urban",
  origin2 = "White",
  topqual2 = "No qualification"
)

# Set reference levels for factor columns
for (col in names(reference_levels)) {
  if (is.factor(data[[col]])) {
    data[[col]] <- relevel(data[[col]], ref = reference_levels[[col]])
  } else if (is.character(data[[col]])) {
    levels(data[[col]]) <- c(reference_levels[[col]], levels(data[[col]])[levels(data[[col]]) != reference_levels[[col]]])
  }
}

# Define model
model <- glm(current_smoker ~ age_estim + I(age_estim ^ 2) + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex + qimd19:urban14b,
             data = data,
             family = "binomial")

# Extract coefficients and CIs
coef_data <- summary(model)$coefficients

# Create a data frame
forest_data <- data.frame(
  variable = rownames(coef_data),
  estimate = coef_data[,1],
  ci_lower = coef_data[,1] - 1.96 * coef_data[,2],
  ci_upper = coef_data[,1] + 1.96 * coef_data[,2]   
)

# Convert from log-odds to odds ratio
forest_data$estimate <- exp(forest_data$estimate)
forest_data$ci_lower <- exp(forest_data$ci_lower)
forest_data$ci_upper <- exp(forest_data$ci_upper)

# Create forest plot of odds ratios
ggplot(forest_data, aes(x = estimate, y = variable, colour = case_when(variable == "(Intercept)"~ "black", estimate > 1 ~ "green", T ~ "red"))) + theme_minimal() +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = ci_lower, xmax = ci_upper), height = 0) +
  scale_x_continuous(breaks = c(0, 0.5, 1, 1.5, 2)) +
  scale_color_identity() +
  labs(x = "Odds Ratio", y = "Variable") +
  guides(color = FALSE)  + geom_vline(xintercept = 1, colour = "black", size = 0.5)
```

For interpretability, we decided to include a forest plot of the odds ratio for each variable in our model, as the log-odds can be difficult to interpret. The intercept 0.257 can be interpreted as the probability of a white, non-married, unqualified male living in urban area being a smoker, using the reference levels of each factor. On average, the blue factors increase the probability and the red factors decrease the probability. Being Black, Asian, Married or a female significantly decreases this probability, so this is evidence of a socioeconomic effect.

### Which lifestyle habits are associated with systolic blood pressure?

We chose to model the systolic blood pressure (BP) using the Inverse-Normal distribution with a $1/\mu_i^2$ link function. This distribution was a suitable choice because this variable has a lot of outliers, is right-skewed and strictly positive. We also tested a Log-Normal distribution, a Normal distribution with identity link and a Gamma distribution with an inverse link but found that the Inverse-Normal distribution was best able to account for the higher values of BP in the Q-Q plots. The data we used to fit this model was the same training data set as the Binomial model. We filtered out *NA* values of BMI and BP as we only want to consider respondents that had lab measurements taken, leaving us with `r NROW(filter(train16plus , BMIVal <= 54, !is.na(omsysval), !is.na(BMIVal)))` observations.

```{r output-relationship-plots, include = T, fig.height=5, fig.width=12, fig.cap="Relationship of BMI and Age with Mean Systolic Blood Pressure"}
p1 <- create_relationship_plots('age_estim', labels = list(x = "Estimated Age (yrs)"))
p2 <- create_relationship_plots('BMIVal', labels = list(x = "Body Mass Index (kg/m^2)"))

cowplot::plot_grid(p1, p2, nrow=2)
```

We studied the relationship between both age and BMI with BP, shown in Figure \ref{fig:output-relationship-plots}. There was a quadratic relationship between BMI and BP so we decided to include a quadratic term in our model. To account for possible dependencies between variables, we tried fitting models with different interaction terms and found three that were significant. These were between BMI & Age [@AgeBMI], BMI & gender [@SexBMI] and Age & Sex [@AgeSex], which are supported by previous research.

To determine the predictors in the final model, we used a stepwise approach starting with the full model and eliminating variables based on AIC. The final model selected was

$\eta_{ijklm} \sim cig_{ij} + a_i + ms_{ik} + u_{il} + bmi_i + bmi_i^2 + s_{im} + n_i^{alc} + \gamma_{im}^{bmi:s}bmi_i + \gamma_{im}^{a:s}a_i + \alpha_i^{a:bmi}$$

omsysval ~ cigsta3_19 + age_estim + marstatD + urban14b + BMIVal + I(BMIVal ^ 2) + Sex + d7many3_19 + BMIVal:Sex + age_estim:Sex + BMIVal:age_estim

The Q-Q plot in Figure \ref{fig:output-qq-plot} shows a good fit to the distribution and, despite some deviation at both ends of the scale, the model captured the outliers more accurately than other distributions we tried. On our testing dataset we achieved a RMSE of 14.3mmHg, which was relatively small compared to the threshold for hypertensive crisis of 140mmHg+.

```{r output-qq-plot, include = T, fig.height=2, fig.width=4, fig.align='center', fig.cap="Q-Q plot of Inverse-Normal model residuals"}
create_qq_plot(q3_model)
```

We found that, on average, young females are predicted lower blood pressure than young men but as they age, their blood pressure increases at a faster rate. Controlling for other lifestyle choices included in the model, a female's blood pressure can be expected to exceed an equivalent male's at around 72 years old. Figure \ref{fig:output-effect-plots-age} shows this relationship. One of the biggest influences on BP was smoking status, and we found smoking was associated with higher blood pressure for both males and females, also shown in Figure \ref{fig:output-effect-plots}. This effect is largest for males and a typical male can expect a `r round(filter(cig_sex_effects, group == "Male")$percentage_change, digits = 2)`% increase in BP by taking up smoking.

```{r output-effect-plots-age, include = T, fig.height=3, fig.width=6, fig.cap="Marginal effects of Age on Systolic Blood Pressure"}
create_effects_plot(q3_model, c('age_estim', 'Sex'), labels = list(x = 'Estimated Age', y = 'Predicted Mean BP (mm Hg)'))
```

```{r output-effect-plots, include = T, fig.height=5, fig.width=12, fig.cap="Marginal effects of Smoking Status and BMI on Systolic Blood Pressure"}
p1 <- create_effects_plot(q3_model, c('cigsta3_19', 'Sex'), labels = list(x = 'Smoking Status', y = 'Predicted Mean BP (mm Hg)'))
p2 <- create_effects_plot(q3_model, c('BMIVal', 'Sex'), labels = list(x = 'BMI', y = 'Predicted Mean BP (mm Hg)'))
cowplot::plot_grid(p1, p2)
```

Drinking was also related to higher BP, and we observed a linear relationship in Figure \ref{fig:output-effect-plots-alc} with the number of days that alcohol was consumed in the previous week. On average, one extra day of drinking led to an increase of `r round(mean_drinking_change, 2)` mmHg.

```{r output-effect-plots-alc, include = T, fig.height=3, fig.width=6, fig.cap="Marginal effects of alcohol consumption on Systolic Blood Pressure"}
create_effects_plot(q3_model, c('d7many3_19', 'Sex'), labels = list(x = 'Number of Days Alcohol Consumed in the Previous Week', y = 'Predicted Mean BP (mm Hg)'))
```

## Results/Conclusion

Our analysis showed that alcohol consumption is highly common in our sample, with approximately `r round(100 * overall_drinking$p_hat, digits = 1)`% being consumers, while smoking and vaping rates were lower at `r round(100 * overall_smoking$p_hat, digits = 1)`% and `r round(100 * overall_ecigs$p_hat, digits = 1)`%, respectively. Older males showed the highest tendencies for alcohol consumption, with 'frequent' drinking the most prevalent among males aged 65-74. Unlike 'frequent' alcohol consumption, the prevalence of smoking decreases with age. Individuals aged 16-24 appear to be the most susceptible to smoking cigarettes, indicating a significant issue within youth culture. Moreover, we found interesting, opposing associations between deprivation levels and smoking and drinking behaviours. Smoking prevalence seemed to increase as deprivation levels decreased, whereas alcohol consumption appeared to do the opposite.

To help us uncover the underlying socio-economic factors that may drive the prevalence of smoking, we looked at the most 'comparable' respondent type in our dataset. This 'respondent' is a white, single male who has no qualifications and lives in an urban area. We found that the probability of our hypothetical respondent being a smoker is approximately 25%, which can be seen from Figure \ref{fig:output-forest-plot}. This is notably higher than the population average of `r round(100 * overall_smoking$p_hat, digits = 1)`. The smoking prevalence estimate in our sample is significantly higher than that of the population of interest (16.5% vs. 13.9%, outside of the CI in Table \ref{tab:output-estimates-table}). The only socio-economic variables to certainly increase this probability is the deprivation level our respondent falls under. The rest of the socio-economic variables we have access to, appear to decrease the likelihood of smoking. For example, if our respondent is any of the following: Asian, black, married, or went on to further education, the chances of them being a smoker is at-least halved.

If we had more observations from current smokers, we may have been able to increase the positive predictive value of our final model for smoking status, and hence obtain increased accuracy. Due to the cross-sectional format of the study, we are
unable to comment on temporal changes in smoking habits or establish a causal relationship. Furthermore, access to data from the whole of the UK could improve generalisability, but including participants with hypertensive crisis helps to generalise our findings to those who may need the most attention and preventative care from healthcare providers.

```{=tex}
\clearpage
\onecolumn
```
# References
