---
output: 
  pdf_document:
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    extra_dependencies: ["float"]
header-includes:
  - \usepackage{hyperref}
  - \usepackage{array}   
  - \usepackage{caption}
  - \usepackage{graphicx}
  - \usepackage{multirow}
  - \usepackage{hhline}
  - \usepackage{calc}
  - \usepackage{tabularx}
  - \usepackage[para,online,flushleft]{threeparttable} 
  - \DeclareMathOperator{\logit}{logit}
  - \DeclareMathOperator{\var}{var}
geometry: margin=0.5in
pagenumbers: no
fontsize: 11pt
endnote: no
title: "Analysis of Health Survey for England (HSE) 2019"
author: Candidate Numbers Here
abstract: "This report provides an analysis of data related to health, age, socio-economic factors and lifestyle habits in adults (from the age of 16) from the population in England, derived from the Health Survey for England 2019."
date: "`r format(Sys.time(), '%B %d, %Y')`"
bibliography: bibliography.bib
nocite: '@*'
link-citations: true
---

<!-- Remove page numbers -->
\pagenumbering{gobble}

```{r setup, include=F}
knitr::opts_chunk$set(include = F, echo = F, message = F, warning = F, fig.pos = "H", out.extra = "")
```

<!-- Put all code at start and only call plots when we need them in line -->

```{r initial data filtering and splitting}
library(dplyr)
library(haven)
library(ggplot2)
library(broom)
library(pROC)
library(caret)

set.seed(200)

load("hsesub.Rdata")

fct_variables <- c(
  'Sex', 'Age35g', 'ag16g10', 'topqual2', 'urban14b', 'origin2', 'marstatD', 'GOR1', 'cigsta3_19', 'NDPNow_19', 'drinkYN_19', 'dnoft_19'
)

# filter to over 16s, relabel all factors
sd16plus <- subdat %>% 
  filter(Age35g >= 7 & !is.na(Age35g)) %>% 
  # Remove duplicated entries
  distinct(pick(!c(SerialA)), .keep_all = T) %>% 
  # Filter out BMI outliers
  filter(BMIVal <= 54) %>% 
  mutate(
    across(
      all_of(fct_variables), 
      # drop excess factor levels
      ~ droplevels(factor(as.factor(.x), levels = attr(subdat[[cur_column()]], 'labels'), labels = names(attr(subdat[[cur_column()]], 'labels'))))
    ), 
    across(!all_of(fct_variables), as.numeric)
  ) %>% 
  mutate(
    # Grouping variables
    marstatD = as.factor(
      case_when(
        grepl('Married', marstatD) ~ 'Married', 
        !is.na(marstatD) ~ 'Not Married',
        T ~ NA_character_
      )
    ),
    topqual2 = as.factor(
      case_when(
        grepl('Higher ed|FT Student', topqual2) ~ 'Higher Education', 
        grepl('NVQ4', topqual2) ~ 'Further Education',
        grepl('NVQ3', topqual2) ~ 'A-Level equiv.',
        grepl('NVQ1|NVQ2', topqual2) ~ 'GCSE equiv.',
        T ~ as.character(topqual2)
      )
    ),
    dnoft_19 = as.factor(
      case_when(
        dnoft_19 %in% c('Almost every day', 'Five or six days a week', 'Three or four days a week') ~ "Frequent",
        dnoft_19 %in% c('Once or twice a week', 'Once or twice a month') ~ "Occasional",
        dnoft_19 %in% c('Once every couple of months', 'Once or twice a year', 'Not at all in the last 12 months') ~ "Rarely",
        T ~ NA_character_
      )
    ),
    urban14b = as.factor(
      case_when(
        grepl('Town', urban14b) ~ 'Not Urban', 
        T ~ as.character(urban14b)
      )
    ),
    origin2 = as.factor(
      case_when(
        grepl('Mixed', origin2) ~ 'Multiple',
        grepl('other', origin2) ~ 'Other',
        T ~ as.character(origin2)
      )
    ),
    NDPNow_19 = as.factor(
      case_when(
        grepl('Both|E-cigarettes', NDPNow_19) ~ 'Smokes E-cigarettes',
        grepl('None|Other', NDPNow_19) ~ 'Doesn\'t smoke E-cigarettes',
        T ~ NA_character_
      )
    ),
    
    # Define new variables
    
    current_smoker = as.numeric(cigsta3_19 == "Current cigarette smoker"),
    age_estim =
      case_when(
        Age35g != "90+" ~ purrr::map2_dbl(as.numeric(substr(Age35g,0,2)), as.numeric(substr(Age35g,4,5)), \(x, y) mean(c(x, y))),
        !(is.na(Age35g)) ~ 92.5,
        T ~ NA_real_
      )
  )
```

```{r proportion bar plot function}
create_proportion_bar_plot <- function(group_variable, facet_variable, plotting_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(
      !if_any(all_of(plotting_variable), is.na)
    ) %>% 
    group_by(
      across(all_of(c(group_variable, facet_variable, plotting_variable)))
    ) %>% 
    summarise(n = n(), .groups = 'drop_last') %>% 
    mutate(proportion = n / sum(n))
  
  ggplot(data, aes(x = !!sym(group_variable), y = proportion, fill = !!sym(plotting_variable))) +
    geom_bar(stat = "identity", position = "dodge") +
    facet_wrap(as.formula(paste("~", facet_variable)), scales = "free_x") +
    scale_fill_brewer(palette = "Pastel1", name = labels$legend.title) +
    labs(x = labels$x, y = labels$y) +
    scale_y_continuous(labels = scales::percent) +
    guides(
      fill = guide_legend(title.position = 'top', title.hjust = 0.5, title.theme = element_text(face = 'bold'))
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = 'bottom',
      strip.text = element_text(face = 'bold', size = 12),
      legend.text = element_text(size = 6), 
      legend.key.size = unit(0.4, 'cm')
    )
}
```

```{r stacked bar plot function}
create_stacked_bar_plot <- function(group_variable, plotting_variable, labels = list()) {
  data <- sd16plus %>% 
    filter(
      !if_any(all_of(plotting_variable), is.na)
    ) %>% 
    group_by(
      across(all_of(c(group_variable, plotting_variable)))
    ) %>% 
    summarise(n = n(), .groups = 'drop_last') %>% 
    mutate(proportion = n / sum(n))
  
  ggplot(data, aes(x = !!sym(group_variable), y = proportion, fill = !!sym(plotting_variable))) +
    geom_bar(stat = "identity", position = "stack") +
    scale_fill_brewer(palette = "Pastel3", name = labels$legend.title) +
    scale_y_continuous(labels = scales::percent) +
    guides(
      fill = guide_legend(title.position = 'top', title.hjust = 0.5, title.theme = element_text(face = 'bold'))
    ) +
    labs(x = labels$x, y = labels$y) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      legend.position = 'bottom', 
      legend.text = element_text(size = 6), 
      legend.key.size = unit(0.4, 'cm')
    )
}
```

```{r confidence interval calculation}
# function to calculate the confidence intervals
calculate_binomial_ci <- function(dat_vec, weights = rep(1, length.out = length(dat_vec)), alpha = 0.05) {
  dat_vec <- as.numeric(dat_vec)
  
  n <- length(dat_vec)
  
  p_hat <- sum(dat_vec * weights) / sum(weights)
  
  var_est <- p_hat * (1 - p_hat) / sum(weights)
  
  ci <- p_hat + c(-1, 1) * qnorm(1 - alpha / 2) * sqrt(var_est)
  
  list(n = n, p_hat = p_hat, alpha = alpha, ci = ci)
}

# Initial calculations of prevelance across the three categories
# here we use full dataset, not split into test and train
drinking_na <- is.na(sd16plus$drinkYN_19)
overall_drinking <- calculate_binomial_ci(sd16plus$drinkYN_19[!drinking_na] == 'Yes', sd16plus$wt_int[!drinking_na])

smoking_na <- is.na(sd16plus$cigsta3_19)
overall_smoking <- calculate_binomial_ci(sd16plus$cigsta3_19[!smoking_na] == 'Current cigarette smoker', sd16plus$wt_int[!smoking_na])

ecig_na <- is.na(sd16plus$NDPNow_19)
overall_ecigs <- calculate_binomial_ci(sd16plus$NDPNow_19[!ecig_na] == 'Smokes E-cigarettes', sd16plus$wt_int[!ecig_na])

# Creating table output
prevelance_table <- tibble(
  Category = c('Drinking', 'Smoking', 'Smoking E-cigarettes'),
  Estimate = c(overall_drinking$p_hat, overall_smoking$p_hat, overall_ecigs$p_hat),
  LowerCI = c(overall_drinking$ci[1], overall_smoking$ci[1], overall_ecigs$ci[1]),
  UpperCI = c(overall_drinking$ci[2], overall_smoking$ci[2], overall_ecigs$ci[2])
) %>% 
  mutate(
    CI = glue::glue('({100 * signif(LowerCI, digits = 3)}%, {100 * signif(UpperCI, digits = 3)}%)'),
    Estimate = paste0(100 * signif(Estimate, digits = 3), '%')
  ) %>% 
  select(-c(LowerCI, UpperCI))
```

```{r calculations by age groups}
create_confidence_int_plot <- function(group_variable, facet_variable, plotting_variable, required_levels, labels = list()) {
  data <- sd16plus %>% 
    filter(!if_any(all_of(plotting_variable), is.na)) %>% 
    group_by(
      across(all_of(c(group_variable, facet_variable)))
    ) %>% 
    summarise(
      across(all_of(plotting_variable), ~ list(.x %in% required_levels), .names = 'dat_vec'),
      wt_int = list(wt_int), .groups = 'drop'
    ) %>% 
    mutate(
      summary = purrr::map2(dat_vec, wt_int, calculate_binomial_ci),
      p_hat = purrr::map_dbl(summary, \(x) x$p_hat),
      lower = purrr::map_dbl(summary, \(x) x$ci[1]),
      upper = purrr::map_dbl(summary, \(x) x$ci[2])
    ) %>% 
    select(-c(dat_vec, wt_int, summary))
  
  ggplot(data = data, aes(x = !!sym(group_variable), y = p_hat, ymin = lower, ymax = upper)) +
    geom_bar(stat = 'identity', fill = 'skyblue') +
    geom_errorbar(width = 0.5) +
    facet_wrap(as.formula(paste('~ ', facet_variable))) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = labels$x, y = labels$y) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1), 
      strip.text = element_text(face = 'bold', size = 12)
    )
}
```

```{r splitting dataset into test and train}
# split data into test/train
train16plus <- sd16plus %>% sample_frac(0.8) 
test16plus <- sd16plus %>% anti_join(train16plus, by = c('SerialA'))
```

```{r summary of data set}
variable_na_table <- sd16plus %>% 
  select(-c(SerialA, current_smoker, age_estim)) %>% 
  summarise(
    across(everything(), ~ sum(is.na(.x)))
  ) %>% 
  tidyr::pivot_longer(
    cols = everything(), names_to = 'Variable', values_to = 'SumNA'
  ) %>% 
  # Can filter out variables with 0 NAs for table?
  filter(SumNA != 0) %>%
  mutate(PercNA = paste0(100 * signif(SumNA / NROW(train16plus), digits = 3), '%')) %>% 
  arrange(desc(SumNA))

variable_na_table_train <- train16plus %>% 
  select(-c(SerialA, current_smoker, age_estim)) %>% 
  summarise(
    across(everything(), ~ sum(is.na(.x)))
  ) %>% 
  tidyr::pivot_longer(
    cols = everything(), names_to = 'Variable', values_to = 'SumNA'
  ) %>% 
  # Can filter out variables with 0 NAs for table?
  filter(SumNA != 0) %>%
  mutate(PercNA = paste0(100 * signif(SumNA / NROW(train16plus), digits = 3), '%')) %>% 
  arrange(desc(SumNA))
```

```{r fitting q2 model}
get_binom_model_diagnostics <- function(formula) {
  fit <- glm(formula, data = train16plus, family = binomial)
  
  aic <- AIC(fit)
  
  # predicting train values
  pred_train <- predict(fit, newdata = train16plus, type = 'response')
  
  train_rmse <- sqrt(mean((train16plus$current_smoker - pred_train) ^ 2, na.rm = T))
  
  # predicting test values
  pred_test <- predict(fit, newdata = test16plus, type = 'response')
  
  auc <- as.numeric(auc(response = test16plus$current_smoker, predictor = pred_test))
  
  test_rmse <- sqrt(mean((test16plus$current_smoker - pred_test) ^ 2, na.rm = T))
  
  accuracy <- mean(round(pred_test) == test16plus$current_smoker, na.rm = T)
  
  tibble(
    model = list(fit), link = 'logit', family = 'binomial', aic = aic, auc = auc, train_rmse = train_rmse, test_rmse = test_rmse, accuracy = accuracy
  )
}

# Define the model formulas
binom_model_formulas <- list(
  glm1 = current_smoker ~ age_estim + I(age_estim ^ 2) + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex + qimd19:urban14b,
  glm2 = current_smoker ~ age_estim + I(age_estim ^ 2) + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm3 = current_smoker ~ age_estim + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm4 = current_smoker ~ Age35g + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex,
  glm5 = current_smoker ~ ag16g10 + marstatD + qimd19 + urban14b + origin2 + topqual2 + Sex
)

# loop over formulas
model_diagnostics <- lapply(binom_model_formulas, get_binom_model_diagnostics) %>% bind_rows()

# selected model
q2_model <- model_diagnostics$model[[which.min(model_diagnostics$aic)]]
```

```{r create q2 model selector table}
model_specs <- c(
  "$\\logit(\\mu_i) \\sim a_i + a_i^2 + m_i + q_i + u_i + o_i + t_i + s_i + q_i:u_i$",
  "$\\logit(\\mu_i) \\sim a_i + a_i^2 + m_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\logit(\\mu_i) \\sim a_i + m_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\logit(\\mu_i) \\sim a_i^{(5)} + m_i + q_i + u_i + o_i + t_i + s_i$",
  "$\\logit(\\mu_i) \\sim a_i^{(10)} + m_i + q_i + u_i + o_i + t_i + s_i$"
)

model_table_output <- model_diagnostics %>% 
  select(aic, auc, train_rmse, test_rmse, accuracy) %>% 
  mutate(
    formula = model_specs, 
    aic = round(aic, digits = 1),
    across(c(auc:accuracy), ~ round(.x, digits = 3)),
    .before = 1
  )
```

```{r calibration chart function}
create_binom_model_calibration_chart <- function(fit) {
  pred <- predict(fit, test16plus, type = 'response')
  
  actual <- test16plus$current_smoker
  
  ggplot(mapping = aes(x = pred, y = actual)) +
    stat_summary_bin(fun = "mean", bins = 10, geom = "point") +  # Bin and plot mean actual per bin
    stat_summary_bin(fun = "mean", bins = 10, geom = "line", aes(group = 1)) +  # Connect points with lines
    labs(x = "Predicted Probability", y = "Mean Actual Outcome") +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red") +
    xlim(c(0, 1)) +
    ylim(c(0, 1)) +
    theme_minimal()
}
```

```{r distribution plots}
create_distribution_plot <- function(variable, label) {
  ggplot() +
  geom_violin(
    data = sd16plus, aes(y = !!sym(variable), x = as.factor(1)),
    scale = "width", alpha = 0.5, color = "black", fill = "blue"
  ) +
  geom_boxplot(
    data = sd16plus, aes(y = !!sym(variable), x = as.factor(1)),
    width = 0.2,
    fill = "white", 
    outlier.shape = 3, 
    outlier.colour = "red", 
    outlier.alpha = 1, 
    outlier.size = 4
  ) +
  ylab(label) +
  theme_minimal() +
  coord_flip() +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
}
```

```{r fitting q3 model}
q3_model <- glm(
  formula = omsysval ~ cigsta3_19 + age_estim + marstatD + urban14b + BMIVal + I(BMIVal ^ 2) + Sex + d7many3_19 + BMIVal:Sex + age_estim:Sex + BMIVal:age_estim,
  family = inverse.gaussian,
  data = na.omit(train16plus)
)
```

```{r qqplot function}
create_qq_plot <- function(fit) {
  pred <- rstandard(fit)
  
  ggplot(mapping = aes(sample = pred)) +
    stat_qq() +
    stat_qq_line(linetype = 'dashed', col = 'red') +
    theme_minimal() +
    labs(x = "Theoretical Quantiles", y = "Std. Pearson Residuals")
}
```

```{r relationship plots for q3}
create_relationship_plots <- function(variable, labels) {
  ggplot(data = train16plus, aes(x = !!sym(variable), y = omsysval)) +
    geom_point() +
    geom_smooth() +
    labs(y = "Omron Valid Mean Systolic Blood Pressure (mmHg)", x = labels$x) +
    theme_minimal()
}
```


<!-- Start of write-up -->

\newpage
## Summary (Non-Technical)

## Introduction

In the UK, smoking, vaping, and alcohol consumption are widespread, particularly among youngsters. It is crucial to be aware of the consequences and dangers of these habits, and the complications they can cause in later-life.
The Office for National Statistics (ONS), regarded as the foremost statistical institute in the UK, is the “go-to” for insights into public health trends. According to their estimations, approximately 14.1% of the adult population aged 18 and above were identified as cigarette smokers [@1ONS]. Furthermore, their data revealed there were 7,565 deaths attributed to alcohol-specific causes in 2019 [@2ONS].
These statistics alone warrant a need for an understanding of health-related behaviours and the outcome. Therefore, the aim of our study is to investigate not only the prevalence but also the severity of these habits, exploring different socioeconomic factors that may potentially contribute to each. Additionally, we will investigate the greater implications of these bad habits and how they relate to systolic blood pressure levels throughout the UK population.

## Exploratory Analysis

We are using data from the 2019 Health Survey for England (HSE) to conduct our analysis. Before proceeding with any investigations involving the data, we checked for any common errors in large datasets. Our initial step involved pre-processing the data, which entailed filtering observations to include only those above the age of 16 and removing 3 pairs of observations that were identical in every descriptive variable except for the ID, resulting in a dataset of `r NROW(sd16plus)` observations. As we have two different grouped age variables, we ensured they were consistent with one another. *Don't know if this final sentence needs to be included*

*Need the table copied over here with the variable names/a paragraph explaining these*

We also found 36 pairs with exact entries excluding lab measurements, but we do not remove these from our analysis. We suspect these may be individuals who have either initially refused a nurse visit but later changed their mind, or simply have had two nurse visits where their lab measurements vary slightly between the two. The supporting documentation doesn’t state a protocol for repeated visits, so we will assume these are genuine observations from different participants and include them. *Maybe rewording this?*

*I think this table could be replaced with a paragraph that may save space*
All variables are coded as numeric in our dataset, so we recoded all factor variables accordingly. Note that for the purposes of model building, we coded CASI/CAPI responses about alcohol and cigarette consumption in the following way:

| Variable  | Code | Label                                 | Decode                        | 
|-----------|------|---------------------------------------|-------------------------------|
| NDPNow_19 | 1    | E-cigarettes or vaping devices only   | Smokes E-cigarettes           |
|           | 2    | Other nicotine delivery products only | Doesn't smoke E-cigarettes    |     
|           | 3    | Both                                  | Smokes E-cigarettes           |
|           | 4    | None                                  | Doesn't smoke E-cigarettes    |    
|           | -1   | Not Applicable                        | NA                            |
|           | -8   | Don't know                            | NA                            |
|           | -9   | Refused                               | NA                            |
| dnoft_19  | 1    | Almost every day                      | Frequently                    |      
|           | 2    | Five or six days a week               | Frequently                    |
|           | 3    | Three or four days a week             | Frequently                    |
|           | 4    | Once or twice a week                  | Occasionally                  |
|           | 5    | Once or twice a month                 | Occasionally                  |
|           | 6    | Once every couple of months           | Rarely                        |
|           | 7    | Once or twice a year                  | Rarely                        |
|           | 8    | Not at all in the last 12 months      | Rarely                        |
|           | -1   | Not Applicable                        | NA                            |
|           | -8   | Don't know                            | NA                            |
|           | -9   | Refused                               | NA                            |

We code a binary variable to group current smoking status into ‘yes’ or ‘no’, with the ‘Ex-Reg’ smokers falling into the ‘no’ category. For ‘topqual2’ we group respondents into ‘higher education’ or ‘basic education’ *This has changed since*. Similarly, ‘urban14b’ now has two levels being ‘rural’ and ‘urban’ and ‘marstatD’ now only has ‘married’ and ‘not married’ levels.

The number of missing observations for each are shown in Table \ref{tab:output-na-table}:

```{r output-na-table, include = T}
knitr::kable(
  variable_na_table, 
  col.names = c('Variable', 'Missing Values', '% Missing'), 
  caption = "Missing values in the training dataset\\label{tab:output-na-table}"
)
```

As expected, there is a lot of missingness in the lab values, particularly ‘omsysval’. *Maybe some explanation of why this is expected?* When conducting our analysis of these, we will use a subset including only observations with at least one of these taken. The only other variable with a substantial amount of data missing is ‘dnoft_19’ and, as this is derived from a retrospective question, this may be a case of recall bias. Questions involving lifestyle habits such as alcohol consumption are considered sensitive, with many individuals potentially not being willing to answer, more likely to be the issue here. With this level of missingness in ‘dnoft_19’, we decide not to use it in any of our models. ‘topqual2’, ‘origin2’ and ‘marstatD’ are the only demographic variables with any missing entries, with `r filter(variable_na_table, Variable == 'topqual2')$SumNA` observations (`r filter(variable_na_table, Variable == 'topqual2')$PercNA` of the data) missing at least one. As all three of these variables are not necessary for identifiability, we do not expect every participant to answer these questions due to personal preference.

Finally, we analysed the two lab measurement variables in Figure \ref{fig:output-distribution-plots}, finding potential outliers to be present in both. The readings for ‘omsysval’ are collected by taking an average of three readings, each five minutes apart, performed by a trained nurse who deemed each reading to be valid. For this reason, it seems highly unlikely that these readings are mistakes, and we include them in our analysis. However, our BMI variable is estimated if the participants weight is over 130kg. These extremely high BMI values are most likely to be caused by the over-estimation of these participants weights. We deem these to be errors and code them as missing in the dataset.

```{r output-distribution-plots, include = T, fig.height=4, fig.width=12, fig.cap="Distribution of BMI and Mean Systolic Blood Pressure"}
p1 <- create_distribution_plot('omsysval', 'Omron Valid Mean Systolic Blood Pressure (mmHg)')
p2 <- create_distribution_plot('BMIVal', 'Body Mass Index (kg/m^2)') +
  geom_hline(yintercept = c(18.5, 25, 30), colour = c("orange", "orange", "red"), size = 0.5) +
  geom_text(
    aes(x = 0.4, y = c(18.4, 24.9, 29.9), label = c("Underweight", "Overweight", "Obese")), 
    color = "black", angle = 90, size = 4, vjust = 0, hjust = 0
  )

cowplot::plot_grid(p1, p2)
```


```{r output deprivation plot, include = F, fig.width=10, fig.height=3, fig.cap="Drinking, smoking and E-cig status proportions by level of deprivation"}
p1 <- create_stacked_bar_plot('qimd19', 'cigsta3_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'Drinking Status'))
p2 <- create_stacked_bar_plot('qimd19', 'dnoft_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'Smoking Status'))
p3 <- create_stacked_bar_plot('qimd19', 'NDPNow_19', labels = list(x = 'Level of Deprivation', y = 'Proportion', legend.title = 'E-cig Status'))

cowplot::plot_grid(p1, p2, p3)
```

## Methology

### What is the prevelance of drinking, smoking and E-cig usage?

To calculate the prevalence of each habit we assume each of the $n$ observations, $x_1,…,x_n$ , to be independent, identically distributed (iid) random variables (RVs) where $x_i \sim Bern(p)\, \forall i=1,…,n$ and $p$ denotes the probability of an observation having the relevant habit. 
We use the household weights to calculate a weighted Maximum Likelihood Estimate (MLE) of $p$. That is, letting $w_i$ denote the weight of the $i^{th}$ observation, we alter the standard likelihood function of a Bernoulli distribution as below:
$$L(p|\textbf{x}) = \prod_{i = 1}^{n} (p^{x_i}(1-p)^{1-x_i})^{w_i}$$
From this, we calculate our weighted MLE as:
$$\widehat{p} = \frac{\sum_{i=1}^{n} x_iw_i}{\sum_{i=1}^{n} w_i}$$

It can also be shown that this MLE has variance given by $\var(\widehat{p})=\frac{p(1-p)}{\sum_{i=1}^{n}w_i}$, which we can estimate using $\widehat{p}$ and use large sample properties of the MLE to get a normal approximation and estimate 95% confidence intervals for each habit, which are shown in Table \ref{tab:output-estimates-table}.

```{r output-estimates-table, include = T}
knitr::kable(
  prevelance_table, 
  col.names = c('Habit', 'Estimate', 'C.I.'), 
  caption = "Estimates and 95% Confidence Intervals for % of Population\\label{tab:output-estimates-table}"
)
```

**Interpretation of table/results - e-cig is much lower, drinking very common etc**

We segmented our data by gender, age brackets and level of deprivation and regrouped the levels of each lifestyle factor variables into more manageable buckets *This bit should read better, but I'm not sure the changes - just needs to be a sentence to introduce the plots*

```{r output smoking and drinking by age plot, include = T, fig.width=12, fig.height=4, fig.cap="Smoking and drinking status proportions by age group and gender"}
p1 <- create_proportion_bar_plot('ag16g10', 'Sex', 'cigsta3_19', labels = list(x = 'Age Group', y = 'Proportion', legend.title = 'Smoking Status'))
p2 <- create_proportion_bar_plot('ag16g10', 'Sex', 'dnoft_19', labels = list(x = 'Age Group', y = 'Proportion', legend.title = 'Drinking Status'))

cowplot::plot_grid(p1, p2)
```

*I will change this plot to include all three (smoking, drinking, ecigs) in one graph, similarly needs a sentence intro*
 
```{r output prevelance plot, include = T, fig.height=4, fig.width=12, fig.cap="Estimation of the prevelance of smokers by deprivation"}
create_confidence_int_plot('ag16g10', 'Sex', 'cigsta3_19', required_levels = c('Current cigarette smoker'), list(x = 'Age Group', y = '% Smokers'))
```

We found that the usage of e-cigarette usage among adults is relatively low, making it challenging to dissect any significant trends within the data. *Maybe reword?* We noted an inverse correlation between age and the proportion of 'occasional' drinking, while 'frequent' drinking showed a positive correlation. Additionally, males demonstrate a higher prevalence of drinking across nearly all demographic categories in comparison to females. ‘Active’ smoking appears to follow a similar relationship to ‘occasional’ drinkers, with the number of ‘active’ smokers decreasing with age. Interestingly, the proportion of males who quit smoking in later-life is consistently greater than that of females.

*This probably needs rewording*
It is important to mention the variable 'Level of Deprivation' ranges from 1 (meaning most deprived) to 5 (least deprived). We can clearly see that smoking prevalence increases with our deprivation variable, meaning that smokers tend to be from lower levels of deprivation. This correlation may be caused by the hefty tobacco duties the UK impose on its’ residents [@GovUK]. Less deprived individuals they can take-up more unnecessary, expensive habits, with smoking being one of the main candidates.

### How is smoking associated with socioeconomic factors and age?

Before attempting to fit any suitable models, we split the data into a 80/20 test train data. This reduces the risk of overfitting and allows us to test the predictive power of each model.

This leaves us with `r NROW(train16plus)` observations in our training dataset. *Summary of NA of this? maybe just important variables, i.e. smoking binary*

We use the binary smoker/non-smoker variable as a response and fit... *Finish this paragraph!*

*Reword intro here* This suggests that modelling age as continuous may be more effective. To achieve this, we defined the estimated age of the $i^{th}$ observation as the midpoint of their respective 5-year age bracket (taking the estimation of the 90+ category as 92.5), denoted $a_i$. We believe that age may represent a somewhat quadratic effect on the probability of smoking, leading us to include a $a_i^2$ term in our model. A comparison of these models are summarised in Table \ref{tab:output-model-selection-table}.

```{r output-model-selection-table, include = T}
knitr::kable(
  model_table_output,
  col.names = c('Linear Predictor', 'Train AIC', 'Test AUC', "Train RMSE", "Test RMSE", 'Test Accuracy'), 
  caption = "Comparison of selected model evaluations\\label{tab:output-model-selection-table}",
  escape = FALSE
)
```

We selected the model based on AIC, which should help us find balance between model complexity and how well the model fits the data. This approach helps avoid overfitting meaning that the model generalises well to new data, without any loss of practicality.

To test the predictive performance of our model using our test data, we plot the predicted probability of each ‘probability bin’ against the mean actual outcomes and obtained the calibration chart in Figure \ref{fig:output-calibration-chart}. As we can see the calibration curve closely follows the line $y = x$, which is indicative of a well-calibrated model.

```{r output-calibration-chart, include = T, fig.width=4, fig.height=3, fig.align='center', fig.cap="Calibration chart for Binomial model"}
create_binom_model_calibration_chart(q2_model)
```

We show a forest plot of the odds ratio in Figure *Need code for this* for each variable in our model. Note, it is important to state the reference level of each factor variable, so we have a baseline for comparison among other levels. The intercept (roughly 0.25) can be interpreted as the probability of being a smoker if all factor variables are at their reference level. Any blue variables, i.e. age, imd and urban, increase the probability by a scale of its corresponding odds ratio and all red variables are associated with a decreased probability of being a smoker.

*Limitations of model -*

### Which lifestyle habits are associated with systolic blood pressure?

*I will do this tomorrow!*

```{r output qq plot for q3, include = T, fig.height=3, fig.width=4, fig.align='center', fig.cap="Q-Q plot of Inverse-Normal model residuals"}
create_qq_plot(q3_model)
```

```{r output relationship plots, include = T, fig.height=4, fig.width=12, fig.cap="Relationship of BMI and Age with Mean Systolic Blood Pressure"}
p1 <- create_relationship_plots('age_estim', labels = list(x = "Estimated Age (yrs)"))
p2 <- create_relationship_plots('BMIVal', labels = list(x = "Body Mass Index (kg/m^2)"))

cowplot::plot_grid(p1, p2)
```

## Results/Conclusion

Our analysis showed that alcohol consumption is extremely common among UK adults, with approximately `r round(100 * overall_drinking$p_hat, digits = 1)`% being consumers, while smoking and vaping rates are lower at `r round(100 * overall_smoking$p_hat, digits = 1)`% and `r round(100 * overall_ecigs$p_hat, digits = 1)`%, respectively. Older males show the highest tendencies for alcohol consumption, with ‘frequent’ drinking the most prevalent among males aged 65-74. Unlike ‘frequent’ alcohol consumption, the prevalence of smoking decreases with age. Individuals aged 16-24 appear to be the worst offenders when it comes to smoking cigarettes, indicating a significant issue within youth culture. Moreover, we found an interesting relationship between deprivation levels and smoking and drinking behaviours. Smoking prevalence seemed to increase as deprivation levels decrease, while alcohol consumption appeared to do the opposite.

To help us uncover the underlying socio-economic factors that may drive the prevalence of smoking, we first looked at the most ‘comparable’ respondent type in our dataset. This ‘respondent’ is a white, single male who has no qualifications and lives in an urban area. We found that the probability of our hypothetical respondent being a smoker is approximately 25% *Where is this from?* (notably higher than the population average of `r round(100 * overall_smoking$p_hat, digits = 1)`). *Maybe worth talking about confidence intervals here - is value outside 95%* The only socio-economic variables to certainly increase this probability is the deprivation level our respondent falls under. The rest of the socio-economic variables we have access to, appear to decrease the likelihood of smoking. For example, if our respondent is any of the following: Asian, black, married, or went on to further education, the chances of them being a smoker is at-least halved.

@Main *?*

\newpage
# References